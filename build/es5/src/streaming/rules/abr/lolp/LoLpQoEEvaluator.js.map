{"version":3,"sources":["../../../../../../../src/streaming/rules/abr/lolp/LoLpQoEEvaluator.js"],"names":["LoLpQoeEvaluator","instance","voPerSegmentQoeInfo","segmentDuration","maxBitrateKbps","minBitrateKbps","_setup","_resetInitialSettings","setupPerSegmentQoe","sDuration","maxBrKbps","minBrKbps","_createQoeInfo","fragmentType","fragmentDuration","qoeInfo","QoeInfo","type","weights","bitrateReward","bitrateSwitchPenalty","rebufferPenalty","latencyPenalty","push","threshold","penalty","playbackSpeedPenalty","logSegmentMetrics","segmentBitrate","segmentRebufferTime","currentLatency","currentPlaybackSpeed","_logMetricsInQoeInfo","bitrate","rebufferTime","latency","playbackSpeed","bitrateWSum","lastBitrate","bitrateSwitchWSum","Math","abs","rebufferWSum","i","length","latencyRange","latencyWSum","playbackSpeedWSum","totalQoe","getPerSegmentQoe","calculateSingleUseQoe","singleUseQoeInfo","reset","__dashjs_factory_name","FactoryMaker","getClassFactory"],"mappings":"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","file":"LoLpQoEEvaluator.js","sourcesContent":["/**\r\n * The copyright in this software is being made available under the BSD License,\r\n * included below. This software may be subject to other third party and contributor\r\n * rights, including patent rights, and no such rights are granted under this license.\r\n *\r\n * Copyright (c) 2013, Dash Industry Forum.\r\n * All rights reserved.\r\n *\r\n * Redistribution and use in source and binary forms, with or without modification,\r\n * are permitted provided that the following conditions are met:\r\n *  * Redistributions of source code must retain the above copyright notice, this\r\n *  list of conditions and the following disclaimer.\r\n *  * Redistributions in binary form must reproduce the above copyright notice,\r\n *  this list of conditions and the following disclaimer in the documentation and/or\r\n *  other materials provided with the distribution.\r\n *  * Neither the name of Dash Industry Forum nor the names of its\r\n *  contributors may be used to endorse or promote products derived from this software\r\n *  without specific prior written permission.\r\n *\r\n *  THIS SOFTWARE IS PROVIDED BY THE COPYRIGHT HOLDERS AND CONTRIBUTORS AS IS AND ANY\r\n *  EXPRESS OR IMPLIED WARRANTIES, INCLUDING, BUT NOT LIMITED TO, THE IMPLIED\r\n *  WARRANTIES OF MERCHANTABILITY AND FITNESS FOR A PARTICULAR PURPOSE ARE DISCLAIMED.\r\n *  IN NO EVENT SHALL THE COPYRIGHT HOLDER OR CONTRIBUTORS BE LIABLE FOR ANY DIRECT,\r\n *  INDIRECT, INCIDENTAL, SPECIAL, EXEMPLARY, OR CONSEQUENTIAL DAMAGES (INCLUDING, BUT\r\n *  NOT LIMITED TO, PROCUREMENT OF SUBSTITUTE GOODS OR SERVICES; LOSS OF USE, DATA, OR\r\n *  PROFITS; OR BUSINESS INTERRUPTION) HOWEVER CAUSED AND ON ANY THEORY OF LIABILITY,\r\n *  WHETHER IN CONTRACT, STRICT LIABILITY, OR TORT (INCLUDING NEGLIGENCE OR OTHERWISE)\r\n *  ARISING IN ANY WAY OUT OF THE USE OF THIS SOFTWARE, EVEN IF ADVISED OF THE\r\n *  POSSIBILITY OF SUCH DAMAGE.\r\n */\r\n\r\n/**\r\n * Authors:\r\n * Abdelhak Bentaleb | National University of Singapore | bentaleb@comp.nus.edu.sg\r\n * Mehmet N. Akcay | Ozyegin University | necmettin.akcay@ozu.edu.tr\r\n * May Lim | National University of Singapore | maylim@comp.nus.edu.sg\r\n */\r\nimport FactoryMaker from '../../../../core/FactoryMaker';\r\nimport QoeInfo from './QoeInfo';\r\n\r\nfunction LoLpQoeEvaluator() {\r\n\r\n    let instance,\r\n        voPerSegmentQoeInfo,\r\n        segmentDuration,\r\n        maxBitrateKbps,\r\n        minBitrateKbps;\r\n\r\n    function _setup() {\r\n        _resetInitialSettings();\r\n    }\r\n\r\n    function _resetInitialSettings() {\r\n        voPerSegmentQoeInfo = null;\r\n        segmentDuration = null;\r\n        maxBitrateKbps = null;\r\n        minBitrateKbps = null;\r\n    }\r\n\r\n    function setupPerSegmentQoe(sDuration, maxBrKbps, minBrKbps) {\r\n        // Set up Per Segment QoeInfo\r\n        voPerSegmentQoeInfo = _createQoeInfo('segment', sDuration, maxBrKbps, minBrKbps);\r\n        segmentDuration = sDuration;\r\n        maxBitrateKbps = maxBrKbps;\r\n        minBitrateKbps = minBrKbps;\r\n    }\r\n\r\n    function _createQoeInfo(fragmentType, fragmentDuration, maxBitrateKbps, minBitrateKbps) {\r\n        /*\r\n         * [Weights][Source: Abdelhak Bentaleb, 2020 (last updated: 30 Mar 2020)]\r\n         * bitrateReward:           segment duration, e.g. 0.5s\r\n         * bitrateSwitchPenalty:    0.02s or 1s if the bitrate switch is too important\r\n         * rebufferPenalty:         max encoding bitrate, e.g. 1000kbps\r\n         * latencyPenalty:          if L â‰¤ 1.1 seconds then = min encoding bitrate * 0.05, otherwise = max encoding bitrate * 0.1\r\n         * playbackSpeedPenalty:    min encoding bitrate, e.g. 200kbps\r\n         */\r\n\r\n        // Create new QoeInfo object\r\n        let qoeInfo = new QoeInfo();\r\n        qoeInfo.type = fragmentType;\r\n\r\n        // Set weight: bitrateReward\r\n        // set some safe value, else consider throwing error\r\n        if (!fragmentDuration) {\r\n            qoeInfo.weights.bitrateReward = 1;\r\n        }\r\n        else {\r\n            qoeInfo.weights.bitrateReward = fragmentDuration;\r\n        }\r\n\r\n        // Set weight: bitrateSwitchPenalty\r\n        // qoeInfo.weights.bitrateSwitchPenalty = 0.02;\r\n        qoeInfo.weights.bitrateSwitchPenalty = 1;\r\n\r\n        // Set weight: rebufferPenalty\r\n        // set some safe value, else consider throwing error\r\n        if (!maxBitrateKbps) {\r\n            qoeInfo.weights.rebufferPenalty = 1000;\r\n        }\r\n        else {\r\n            qoeInfo.weights.rebufferPenalty = maxBitrateKbps;\r\n        }\r\n\r\n        // Set weight: latencyPenalty\r\n        qoeInfo.weights.latencyPenalty = [];\r\n        qoeInfo.weights.latencyPenalty.push({ threshold: 1.1, penalty: (minBitrateKbps * 0.05) });\r\n        qoeInfo.weights.latencyPenalty.push({ threshold: 100000000, penalty: (maxBitrateKbps * 0.1) });\r\n\r\n        // Set weight: playbackSpeedPenalty\r\n        if (!minBitrateKbps) qoeInfo.weights.playbackSpeedPenalty = 200;   // set some safe value, else consider throwing error\r\n        else qoeInfo.weights.playbackSpeedPenalty = minBitrateKbps;\r\n\r\n        return qoeInfo;\r\n    }\r\n\r\n    function logSegmentMetrics(segmentBitrate, segmentRebufferTime, currentLatency, currentPlaybackSpeed) {\r\n        if (voPerSegmentQoeInfo) {\r\n            _logMetricsInQoeInfo(segmentBitrate, segmentRebufferTime, currentLatency, currentPlaybackSpeed, voPerSegmentQoeInfo);\r\n        }\r\n    }\r\n\r\n    function _logMetricsInQoeInfo(bitrate, rebufferTime, latency, playbackSpeed, qoeInfo) {\r\n        // Update: bitrate Weighted Sum value\r\n        qoeInfo.bitrateWSum += (qoeInfo.weights.bitrateReward * bitrate);\r\n\r\n        // Update: bitrateSwitch Weighted Sum value\r\n        if (qoeInfo.lastBitrate) {\r\n            qoeInfo.bitrateSwitchWSum += (qoeInfo.weights.bitrateSwitchPenalty * Math.abs(bitrate - qoeInfo.lastBitrate));\r\n        }\r\n        qoeInfo.lastBitrate = bitrate;\r\n\r\n        // Update: rebuffer Weighted Sum value\r\n        qoeInfo.rebufferWSum += (qoeInfo.weights.rebufferPenalty * rebufferTime);\r\n\r\n        // Update: latency Weighted Sum value\r\n        for (let i = 0; i < qoeInfo.weights.latencyPenalty.length; i++) {\r\n            let latencyRange = qoeInfo.weights.latencyPenalty[i];\r\n            if (latency <= latencyRange.threshold) {\r\n                qoeInfo.latencyWSum += (latencyRange.penalty * latency);\r\n                break;\r\n            }\r\n        }\r\n\r\n        // Update: playbackSpeed Weighted Sum value\r\n        qoeInfo.playbackSpeedWSum += (qoeInfo.weights.playbackSpeedPenalty * Math.abs(1 - playbackSpeed));\r\n\r\n        // Update: Total Qoe value\r\n        qoeInfo.totalQoe = qoeInfo.bitrateWSum - qoeInfo.bitrateSwitchWSum - qoeInfo.rebufferWSum - qoeInfo.latencyWSum - qoeInfo.playbackSpeedWSum;\r\n    }\r\n\r\n    // Returns current Per Segment QoeInfo\r\n    function getPerSegmentQoe() {\r\n        return voPerSegmentQoeInfo;\r\n    }\r\n\r\n    // For one-time use only\r\n    // Returns totalQoe based on a single set of metrics.\r\n    function calculateSingleUseQoe(segmentBitrate, segmentRebufferTime, currentLatency, currentPlaybackSpeed) {\r\n        let singleUseQoeInfo = null;\r\n\r\n        if (segmentDuration && maxBitrateKbps && minBitrateKbps) {\r\n            singleUseQoeInfo = _createQoeInfo('segment', segmentDuration, maxBitrateKbps, minBitrateKbps);\r\n        }\r\n\r\n        if (singleUseQoeInfo) {\r\n            _logMetricsInQoeInfo(segmentBitrate, segmentRebufferTime, currentLatency, currentPlaybackSpeed, singleUseQoeInfo);\r\n            return singleUseQoeInfo.totalQoe;\r\n        } else {\r\n            // Something went wrong..\r\n            return 0;\r\n        }\r\n    }\r\n\r\n    function reset() {\r\n        _resetInitialSettings();\r\n    }\r\n\r\n    instance = {\r\n        setupPerSegmentQoe,\r\n        logSegmentMetrics,\r\n        getPerSegmentQoe,\r\n        calculateSingleUseQoe,\r\n        reset\r\n    };\r\n\r\n    _setup();\r\n\r\n    return instance;\r\n}\r\n\r\nLoLpQoeEvaluator.__dashjs_factory_name = 'LoLpQoeEvaluator';\r\nexport default FactoryMaker.getClassFactory(LoLpQoeEvaluator);\r\n\r\n"]}