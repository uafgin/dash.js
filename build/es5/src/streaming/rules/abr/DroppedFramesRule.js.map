{"version":3,"sources":["../../../../../../src/streaming/rules/abr/DroppedFramesRule.js"],"names":["DroppedFramesRule","context","instance","logger","DROPPED_PERCENTAGE_FORBID","GOOD_SAMPLE_SIZE","setup","getInstance","getLogger","getMaxIndex","rulesContext","switchRequest","create","hasOwnProperty","droppedFramesHistory","getDroppedFramesHistory","dfh","getFrameHistory","droppedFrames","totalFrames","maxIndex","SwitchRequest","NO_CHANGE","i","length","droppedVideoFrames","totalVideoFrames","debug","__dashjs_factory_name","FactoryMaker","getClassFactory"],"mappings":"sEACA,wD,yDACA,+C,2DACA,0C,8HAEA,QAASA,kBAAT,EAA6B,CAEzB,GAAMC,SAAU,KAAKA,OAArB,CACA,GAAIC,gBAAJ,CACIC,aADJ,CAGA,GAAMC,2BAA4B,IAAlC,CACA,GAAMC,kBAAmB,GAAzB,CAA8B;AAE9B,QAASC,MAAT,EAAiB,CACbH,OAAS,oBAAMF,OAAN,EAAeM,WAAf,GAA6BC,SAA7B,CAAuCN,QAAvC,CAAT,CACH,CAED,QAASO,YAAT,CAAqBC,YAArB,CAAmC,CAC/B,GAAMC,eAAgB,4BAAcV,OAAd,EAAuBW,MAAvB,EAAtB,CAEA,GAAI,CAACF,YAAD,EAAiB,CAACA,aAAaG,cAAb,CAA4B,yBAA5B,CAAtB,CAA8E,CAC1E,MAAOF,cAAP,CACH,CACD,GAAMG,sBAAuBJ,aAAaK,uBAAb,EAA7B,CACA,GAAID,oBAAJ,CAA0B,CACtB,GAAME,KAAMF,qBAAqBG,eAArB,EAAZ,CACA,GAAIC,eAAgB,CAApB,CACA,GAAIC,aAAc,CAAlB,CACA,GAAIC,UAAWC,wBAAcC,SAA7B,CACA,IAAK,GAAIC,GAAI,CAAb,CAAgBA,EAAIP,IAAIQ,MAAxB,CAAgCD,GAAhC,CAAqC,CAAE;AACnC,GAAIP,IAAIO,CAAJ,CAAJ,CAAY,CACRL,cAAgBF,IAAIO,CAAJ,EAAOE,kBAAvB,CACAN,YAAcH,IAAIO,CAAJ,EAAOG,gBAArB,CAEA,GAAIP,YAAcd,gBAAd,EAAkCa,cAAgBC,WAAhB,CAA8Bf,yBAApE,CAA+F,CAC3FgB,SAAWG,EAAI,CAAf,CACApB,OAAOwB,KAAP,CAAa,UAAYP,QAAZ,CAAuB,mBAAvB,CAA6CF,aAA7C,CAA6D,iBAA7D,CAAiFC,WAA9F,EACA,MACH,CACJ,CACJ,CACD,MAAO,4BAAclB,OAAd,EAAuBW,MAAvB,CAA8BQ,QAA9B,CAAwC,CAACF,cAAeA,aAAhB,CAAxC,CAAP,CACH,CAED,MAAOP,cAAP,CACH,CAEDT,SAAW,CACPO,YAAaA,WADN,CAAX,CAIAH,QAEA,MAAOJ,SAAP,CACH,CAEDF,kBAAkB4B,qBAAlB,CAA0C,mBAA1C,C,gBACeC,uBAAaC,eAAb,CAA6B9B,iBAA7B,C","file":"DroppedFramesRule.js","sourcesContent":["\r\nimport FactoryMaker from '../../../core/FactoryMaker';\r\nimport SwitchRequest from '../SwitchRequest';\r\nimport Debug from '../../../core/Debug';\r\n\r\nfunction DroppedFramesRule() {\r\n\r\n    const context = this.context;\r\n    let instance,\r\n        logger;\r\n\r\n    const DROPPED_PERCENTAGE_FORBID = 0.15;\r\n    const GOOD_SAMPLE_SIZE = 375; //Don't apply the rule until this many frames have been rendered(and counted under those indices).\r\n\r\n    function setup() {\r\n        logger = Debug(context).getInstance().getLogger(instance);\r\n    }\r\n\r\n    function getMaxIndex(rulesContext) {\r\n        const switchRequest = SwitchRequest(context).create();\r\n\r\n        if (!rulesContext || !rulesContext.hasOwnProperty('getDroppedFramesHistory')) {\r\n            return switchRequest;\r\n        }\r\n        const droppedFramesHistory = rulesContext.getDroppedFramesHistory();\r\n        if (droppedFramesHistory) {\r\n            const dfh = droppedFramesHistory.getFrameHistory();\r\n            let droppedFrames = 0;\r\n            let totalFrames = 0;\r\n            let maxIndex = SwitchRequest.NO_CHANGE;\r\n            for (let i = 1; i < dfh.length; i++) { //No point in measuring dropped frames for the zeroeth index.\r\n                if (dfh[i]) {\r\n                    droppedFrames = dfh[i].droppedVideoFrames;\r\n                    totalFrames = dfh[i].totalVideoFrames;\r\n\r\n                    if (totalFrames > GOOD_SAMPLE_SIZE && droppedFrames / totalFrames > DROPPED_PERCENTAGE_FORBID) {\r\n                        maxIndex = i - 1;\r\n                        logger.debug('index: ' + maxIndex + ' Dropped Frames: ' + droppedFrames + ' Total Frames: ' + totalFrames);\r\n                        break;\r\n                    }\r\n                }\r\n            }\r\n            return SwitchRequest(context).create(maxIndex, {droppedFrames: droppedFrames});\r\n        }\r\n\r\n        return switchRequest;\r\n    }\r\n\r\n    instance = {\r\n        getMaxIndex: getMaxIndex\r\n    };\r\n\r\n    setup();\r\n\r\n    return instance;\r\n}\r\n\r\nDroppedFramesRule.__dashjs_factory_name = 'DroppedFramesRule';\r\nexport default FactoryMaker.getClassFactory(DroppedFramesRule);"]}