{"version":3,"sources":["../../../../../src/streaming/models/VideoModel.js"],"names":["VideoModel","instance","logger","element","TTMLRenderingDiv","previousPlaybackRate","VIDEO_MODEL_WRONG_ELEMENT_TYPE","context","eventBus","getInstance","stalledStreams","setup","getLogger","initialize","on","Events","PLAYBACK_PLAYING","onPlaying","reset","off","onPlaybackCanPlay","playbackRate","removeEventListener","setPlaybackRate","value","readyState","addEventListener","setCurrentTime","currentTime","stickToBuffered","stickTimeToBuffered","e","code","INVALID_STATE_ERR","setTimeout","time","buffered","getBufferRange","closestTime","closestDistance","i","length","start","end","distanceToStart","Math","abs","distanceToEnd","getElement","setElement","undefined","test","nodeName","preload","setSource","source","src","removeAttribute","load","getSource","getTTMLRenderingDiv","setTTMLRenderingDiv","div","style","position","display","overflow","pointerEvents","top","left","setStallState","type","state","stallStream","isStalled","addStalledStream","event","seeking","indexOf","push","document","createEvent","initEvent","dispatchEvent","removeStalledStream","index","splice","paused","getPlaybackQuality","hasWebKit","hasQuality","result","getVideoPlaybackQuality","droppedVideoFrames","webkitDroppedFrameCount","totalVideoFrames","webkitDecodedFrameCount","creationTime","Date","play","autoplay","p","catch","Promise","name","trigger","PLAYBACK_NOT_ALLOWED","warn","isPaused","pause","isSeeking","getTime","getPlaybackRate","getPlayedRanges","played","getEnded","ended","eventName","eventCallBack","getReadyState","NaN","getClientWidth","clientWidth","getClientHeight","clientHeight","getVideoWidth","videoWidth","getVideoHeight","videoHeight","getVideoRelativeOffsetTop","parentElement","parentNode","host","getBoundingClientRect","getVideoRelativeOffsetLeft","getTextTracks","textTracks","getTextTrack","kind","label","lang","isTTML","isEmbedded","language","addTextTrack","track","appendChild","childElement","removeChild","__dashjs_factory_name","FactoryMaker","getSingletonFactory"],"mappings":"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","file":"VideoModel.js","sourcesContent":["/**\r\n * The copyright in this software is being made available under the BSD License,\r\n * included below. This software may be subject to other third party and contributor\r\n * rights, including patent rights, and no such rights are granted under this license.\r\n *\r\n * Copyright (c) 2013, Dash Industry Forum.\r\n * All rights reserved.\r\n *\r\n * Redistribution and use in source and binary forms, with or without modification,\r\n * are permitted provided that the following conditions are met:\r\n *  * Redistributions of source code must retain the above copyright notice, this\r\n *  list of conditions and the following disclaimer.\r\n *  * Redistributions in binary form must reproduce the above copyright notice,\r\n *  this list of conditions and the following disclaimer in the documentation and/or\r\n *  other materials provided with the distribution.\r\n *  * Neither the name of Dash Industry Forum nor the names of its\r\n *  contributors may be used to endorse or promote products derived from this software\r\n *  without specific prior written permission.\r\n *\r\n *  THIS SOFTWARE IS PROVIDED BY THE COPYRIGHT HOLDERS AND CONTRIBUTORS AS IS AND ANY\r\n *  EXPRESS OR IMPLIED WARRANTIES, INCLUDING, BUT NOT LIMITED TO, THE IMPLIED\r\n *  WARRANTIES OF MERCHANTABILITY AND FITNESS FOR A PARTICULAR PURPOSE ARE DISCLAIMED.\r\n *  IN NO EVENT SHALL THE COPYRIGHT HOLDER OR CONTRIBUTORS BE LIABLE FOR ANY DIRECT,\r\n *  INDIRECT, INCIDENTAL, SPECIAL, EXEMPLARY, OR CONSEQUENTIAL DAMAGES (INCLUDING, BUT\r\n *  NOT LIMITED TO, PROCUREMENT OF SUBSTITUTE GOODS OR SERVICES; LOSS OF USE, DATA, OR\r\n *  PROFITS; OR BUSINESS INTERRUPTION) HOWEVER CAUSED AND ON ANY THEORY OF LIABILITY,\r\n *  WHETHER IN CONTRACT, STRICT LIABILITY, OR TORT (INCLUDING NEGLIGENCE OR OTHERWISE)\r\n *  ARISING IN ANY WAY OUT OF THE USE OF THIS SOFTWARE, EVEN IF ADVISED OF THE\r\n *  POSSIBILITY OF SUCH DAMAGE.\r\n */\r\n\r\nimport FactoryMaker from '../../core/FactoryMaker';\r\nimport EventBus from '../../core/EventBus';\r\nimport Events from '../../core/events/Events';\r\nimport Debug from '../../core/Debug';\r\n\r\nfunction VideoModel() {\r\n\r\n    let instance,\r\n        logger,\r\n        element,\r\n        TTMLRenderingDiv,\r\n        previousPlaybackRate;\r\n\r\n    const VIDEO_MODEL_WRONG_ELEMENT_TYPE = 'element is not video or audio DOM type!';\r\n\r\n    const context = this.context;\r\n    const eventBus = EventBus(context).getInstance();\r\n    const stalledStreams = [];\r\n\r\n    function setup() {\r\n        logger = Debug(context).getInstance().getLogger(instance);\r\n    }\r\n\r\n    function initialize() {\r\n        eventBus.on(Events.PLAYBACK_PLAYING, onPlaying, this);\r\n    }\r\n\r\n    function reset() {\r\n        eventBus.off(Events.PLAYBACK_PLAYING, onPlaying, this);\r\n    }\r\n\r\n    function onPlaybackCanPlay() {\r\n        if (element) {\r\n            element.playbackRate = previousPlaybackRate || 1;\r\n            element.removeEventListener('canplay', onPlaybackCanPlay);\r\n        }\r\n    }\r\n\r\n    function setPlaybackRate(value) {\r\n        if (!element) return;\r\n        if (element.readyState <= 2 && value > 0) {\r\n            // If media element hasn't loaded enough data to play yet, wait until it has\r\n            element.addEventListener('canplay', onPlaybackCanPlay);\r\n        } else {\r\n            element.playbackRate = value;\r\n        }\r\n    }\r\n\r\n    //TODO Move the DVR window calculations from MediaPlayer to Here.\r\n    function setCurrentTime(currentTime, stickToBuffered) {\r\n        if (element) {\r\n            //_currentTime = currentTime;\r\n\r\n            // We don't set the same currentTime because it can cause firing unexpected Pause event in IE11\r\n            // providing playbackRate property equals to zero.\r\n            if (element.currentTime == currentTime) return;\r\n\r\n            // TODO Despite the fact that MediaSource 'open' event has been fired IE11 cannot set videoElement.currentTime\r\n            // immediately (it throws InvalidStateError). It seems that this is related to videoElement.readyState property\r\n            // Initially it is 0, but soon after 'open' event it goes to 1 and setting currentTime is allowed. Chrome allows to\r\n            // set currentTime even if readyState = 0.\r\n            // setTimeout is used to workaround InvalidStateError in IE11\r\n            try {\r\n                currentTime = stickToBuffered ? stickTimeToBuffered(currentTime) : currentTime;\r\n                element.currentTime = currentTime;\r\n            } catch (e) {\r\n                if (element.readyState === 0 && e.code === e.INVALID_STATE_ERR) {\r\n                    setTimeout(function () {\r\n                        element.currentTime = currentTime;\r\n                    }, 400);\r\n                }\r\n            }\r\n        }\r\n    }\r\n\r\n    function stickTimeToBuffered(time) {\r\n        const buffered = getBufferRange();\r\n        let closestTime = time;\r\n        let closestDistance = 9999999999;\r\n        if (buffered) {\r\n            for (let i = 0; i < buffered.length; i++) {\r\n                const start = buffered.start(i);\r\n                const end = buffered.end(i);\r\n                const distanceToStart = Math.abs(start - time);\r\n                const distanceToEnd = Math.abs(end - time);\r\n\r\n                if (time >= start && time <= end) {\r\n                    return time;\r\n                }\r\n\r\n                if (distanceToStart < closestDistance) {\r\n                    closestDistance = distanceToStart;\r\n                    closestTime = start;\r\n                }\r\n\r\n                if (distanceToEnd < closestDistance) {\r\n                    closestDistance = distanceToEnd;\r\n                    closestTime = end;\r\n                }\r\n            }\r\n        }\r\n        return closestTime;\r\n    }\r\n\r\n    function getElement() {\r\n        return element;\r\n    }\r\n\r\n    function setElement(value) {\r\n        //add check of value type\r\n        if (value === null || value === undefined || (value && (/^(VIDEO|AUDIO)$/i).test(value.nodeName))) {\r\n            element = value;\r\n            // Workaround to force Firefox to fire the canplay event.\r\n            if (element) {\r\n                element.preload = 'auto';\r\n            }\r\n        } else {\r\n            throw VIDEO_MODEL_WRONG_ELEMENT_TYPE;\r\n        }\r\n    }\r\n\r\n    function setSource(source) {\r\n        if (element) {\r\n            if (source) {\r\n                element.src = source;\r\n            } else {\r\n                element.removeAttribute('src');\r\n                element.load();\r\n            }\r\n        }\r\n    }\r\n\r\n    function getSource() {\r\n        return element ? element.src : null;\r\n    }\r\n\r\n    function getTTMLRenderingDiv() {\r\n        return TTMLRenderingDiv;\r\n    }\r\n\r\n    function setTTMLRenderingDiv(div) {\r\n        TTMLRenderingDiv = div;\r\n        // The styling will allow the captions to match the video window size and position.\r\n        TTMLRenderingDiv.style.position = 'absolute';\r\n        TTMLRenderingDiv.style.display = 'flex';\r\n        TTMLRenderingDiv.style.overflow = 'hidden';\r\n        TTMLRenderingDiv.style.pointerEvents = 'none';\r\n        TTMLRenderingDiv.style.top = 0;\r\n        TTMLRenderingDiv.style.left = 0;\r\n    }\r\n\r\n    function setStallState(type, state) {\r\n        stallStream(type, state);\r\n    }\r\n\r\n    function isStalled() {\r\n        return (stalledStreams.length > 0);\r\n    }\r\n\r\n    function addStalledStream(type) {\r\n        let event;\r\n\r\n        if (type === null || !element || element.seeking || stalledStreams.indexOf(type) !== -1) {\r\n            return;\r\n        }\r\n\r\n        stalledStreams.push(type);\r\n        if (element && stalledStreams.length === 1) {\r\n            // Halt playback until nothing is stalled.\r\n            event = document.createEvent('Event');\r\n            event.initEvent('waiting', true, false);\r\n            previousPlaybackRate = element.playbackRate;\r\n            setPlaybackRate(0);\r\n            element.dispatchEvent(event);\r\n        }\r\n    }\r\n\r\n    function removeStalledStream(type) {\r\n        let index = stalledStreams.indexOf(type);\r\n        let event;\r\n\r\n        if (type === null) {\r\n            return;\r\n        }\r\n        if (index !== -1) {\r\n            stalledStreams.splice(index, 1);\r\n        }\r\n        // If nothing is stalled resume playback.\r\n        if (element && isStalled() === false && element.playbackRate === 0) {\r\n            setPlaybackRate(previousPlaybackRate || 1);\r\n            if (!element.paused) {\r\n                event = document.createEvent('Event');\r\n                event.initEvent('playing', true, false);\r\n                element.dispatchEvent(event);\r\n            }\r\n        }\r\n    }\r\n\r\n    function stallStream(type, isStalled) {\r\n        if (isStalled) {\r\n            addStalledStream(type);\r\n        } else {\r\n            removeStalledStream(type);\r\n        }\r\n    }\r\n\r\n    //Calling play on the element will emit playing - even if the stream is stalled. If the stream is stalled, emit a waiting event.\r\n    function onPlaying() {\r\n        if (element && isStalled() && element.playbackRate === 0) {\r\n            const event = document.createEvent('Event');\r\n            event.initEvent('waiting', true, false);\r\n            element.dispatchEvent(event);\r\n        }\r\n    }\r\n\r\n    function getPlaybackQuality() {\r\n        if (!element) { return null; }\r\n        let hasWebKit = ('webkitDroppedFrameCount' in element) && ('webkitDecodedFrameCount' in element);\r\n        let hasQuality = ('getVideoPlaybackQuality' in element);\r\n        let result = null;\r\n\r\n        if (hasQuality) {\r\n            result = element.getVideoPlaybackQuality();\r\n        } else if (hasWebKit) {\r\n            result = {\r\n                droppedVideoFrames: element.webkitDroppedFrameCount,\r\n                totalVideoFrames: element.webkitDroppedFrameCount + element.webkitDecodedFrameCount,\r\n                creationTime: new Date()\r\n            };\r\n        }\r\n\r\n        return result;\r\n    }\r\n\r\n    function play() {\r\n        if (element) {\r\n            element.autoplay = true;\r\n            const p = element.play();\r\n            if (p && p.catch && typeof Promise !== 'undefined') {\r\n                p.catch((e) => {\r\n                    if (e.name === 'NotAllowedError') {\r\n                        eventBus.trigger(Events.PLAYBACK_NOT_ALLOWED);\r\n                    }\r\n                    logger.warn(`Caught pending play exception - continuing (${e})`);\r\n                });\r\n            }\r\n        }\r\n    }\r\n\r\n    function isPaused() {\r\n        return element ? element.paused : null;\r\n    }\r\n\r\n    function pause() {\r\n        if (element) {\r\n            element.pause();\r\n            element.autoplay = false;\r\n        }\r\n    }\r\n\r\n    function isSeeking() {\r\n        return element ? element.seeking : null;\r\n    }\r\n\r\n    function getTime() {\r\n        return element ? element.currentTime : null;\r\n    }\r\n\r\n    function getPlaybackRate() {\r\n        return element ? element.playbackRate : null;\r\n    }\r\n\r\n    function getPlayedRanges() {\r\n        return element ? element.played : null;\r\n    }\r\n\r\n    function getEnded() {\r\n        return element ? element.ended : null;\r\n    }\r\n\r\n    function addEventListener(eventName, eventCallBack) {\r\n        if (element) {\r\n            element.addEventListener(eventName, eventCallBack);\r\n        }\r\n    }\r\n\r\n    function removeEventListener(eventName, eventCallBack) {\r\n        if (element) {\r\n            element.removeEventListener(eventName, eventCallBack);\r\n        }\r\n    }\r\n\r\n    function getReadyState() {\r\n        return element ? element.readyState : NaN;\r\n    }\r\n\r\n    function getBufferRange() {\r\n        return element ? element.buffered : null;\r\n    }\r\n\r\n    function getClientWidth() {\r\n        return element ? element.clientWidth : NaN;\r\n    }\r\n\r\n    function getClientHeight() {\r\n        return element ? element.clientHeight : NaN;\r\n    }\r\n\r\n    function getVideoWidth() {\r\n        return element ? element.videoWidth : NaN;\r\n    }\r\n\r\n    function getVideoHeight() {\r\n        return element ? element.videoHeight : NaN;\r\n    }\r\n\r\n    function getVideoRelativeOffsetTop() {\r\n        const parentElement = element.parentNode.host || element.parentNode;\r\n        return parentElement ? element.getBoundingClientRect().top - parentElement.getBoundingClientRect().top : NaN;\r\n    }\r\n\r\n    function getVideoRelativeOffsetLeft() {\r\n        const parentElement = element.parentNode.host || element.parentNode;\r\n        return parentElement ? element.getBoundingClientRect().left - parentElement.getBoundingClientRect().left : NaN;\r\n    }\r\n\r\n    function getTextTracks() {\r\n        return element ? element.textTracks : [];\r\n    }\r\n\r\n    function getTextTrack(kind, label, lang, isTTML, isEmbedded) {\r\n        if (element) {\r\n            for (let i = 0; i < element.textTracks.length; i++) {\r\n                //label parameter could be a number (due to adaptationSet), but label, the attribute of textTrack, is a string => to modify...\r\n                //label could also be undefined (due to adaptationSet)\r\n                if (element.textTracks[i].kind === kind && (label ? element.textTracks[i].label == label : true) &&\r\n                   element.textTracks[i].language === lang && element.textTracks[i].isTTML === isTTML && element.textTracks[i].isEmbedded === isEmbedded) {\r\n                    return element.textTracks[i];\r\n                }\r\n            }\r\n        }\r\n\r\n        return null;\r\n    }\r\n\r\n    function addTextTrack(kind, label, lang, isTTML, isEmbedded) {\r\n        if (!element) {\r\n            return null;\r\n        }\r\n        // check if track of same type has not been already created for previous stream\r\n        // then use it (no way to remove existing text track from video element)\r\n        let track = getTextTrack(kind, label, lang, isTTML, isEmbedded);\r\n        if (!track) {\r\n            track = element.addTextTrack(kind, label, lang);\r\n            track.isEmbedded = isEmbedded;\r\n            track.isTTML = isTTML;\r\n        }\r\n        return track;\r\n    }\r\n\r\n    function appendChild(childElement) {\r\n        if (element) {\r\n            element.appendChild(childElement);\r\n            //in Chrome, we need to differenciate textTrack with same lang, kind and label but different format (vtt, ttml, etc...)\r\n            if (childElement.isTTML !== undefined) {\r\n                element.textTracks[element.textTracks.length - 1].isTTML = childElement.isTTML;\r\n                element.textTracks[element.textTracks.length - 1].isEmbedded = childElement.isEmbedded;\r\n            }\r\n        }\r\n    }\r\n\r\n    function removeChild(childElement) {\r\n        if (element) {\r\n            element.removeChild(childElement);\r\n        }\r\n    }\r\n\r\n    instance = {\r\n        initialize: initialize,\r\n        setCurrentTime: setCurrentTime,\r\n        play: play,\r\n        isPaused: isPaused,\r\n        pause: pause,\r\n        isStalled,\r\n        isSeeking: isSeeking,\r\n        getTime: getTime,\r\n        getPlaybackRate: getPlaybackRate,\r\n        setPlaybackRate: setPlaybackRate,\r\n        getPlayedRanges: getPlayedRanges,\r\n        getEnded: getEnded,\r\n        setStallState: setStallState,\r\n        getElement: getElement,\r\n        setElement: setElement,\r\n        setSource: setSource,\r\n        getSource: getSource,\r\n        getTTMLRenderingDiv: getTTMLRenderingDiv,\r\n        setTTMLRenderingDiv: setTTMLRenderingDiv,\r\n        getPlaybackQuality: getPlaybackQuality,\r\n        addEventListener: addEventListener,\r\n        removeEventListener: removeEventListener,\r\n        getReadyState: getReadyState,\r\n        getBufferRange: getBufferRange,\r\n        getClientWidth: getClientWidth,\r\n        getClientHeight: getClientHeight,\r\n        getTextTracks: getTextTracks,\r\n        getTextTrack: getTextTrack,\r\n        addTextTrack: addTextTrack,\r\n        appendChild: appendChild,\r\n        removeChild: removeChild,\r\n        getVideoWidth: getVideoWidth,\r\n        getVideoHeight: getVideoHeight,\r\n        getVideoRelativeOffsetTop: getVideoRelativeOffsetTop,\r\n        getVideoRelativeOffsetLeft: getVideoRelativeOffsetLeft,\r\n        reset: reset\r\n    };\r\n\r\n    setup();\r\n\r\n    return instance;\r\n}\r\n\r\nVideoModel.__dashjs_factory_name = 'VideoModel';\r\nexport default FactoryMaker.getSingletonFactory(VideoModel);\r\n"]}