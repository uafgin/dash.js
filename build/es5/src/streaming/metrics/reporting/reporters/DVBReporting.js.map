{"version":3,"sources":["../../../../../../../src/streaming/metrics/reporting/reporters/DVBReporting.js"],"names":["DVBReporting","config","instance","context","metricSerialiser","randomNumberGenerator","reportingPlayerStatusDecided","isReportingPlayer","reportingUrl","rangeController","USE_DRAFT_DVB_SPEC","allowPendingRequestsToCompleteOnReset","pendingRequests","metricsConstants","setup","getInstance","resetInitialSettings","doGetRequest","url","successCB","failureCB","req","XMLHttpRequest","oncomplete","reqIndex","indexOf","splice","status","push","open","onloadend","onerror","send","e","report","type","vos","Array","isArray","isEnabled","forEach","vo","serialise","DVB_ERRORS","initialize","entry","rc","probability","dvb_reportingUrl","Error","dvb_probability","random","reset","abort","__dashjs_factory_name","dashjs","FactoryMaker","getClassFactory"],"mappings":"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","file":"DVBReporting.js","sourcesContent":["/**\r\n * The copyright in this software is being made available under the BSD License,\r\n * included below. This software may be subject to other third party and contributor\r\n * rights, including patent rights, and no such rights are granted under this license.\r\n *\r\n * Copyright (c) 2013, Dash Industry Forum.\r\n * All rights reserved.\r\n *\r\n * Redistribution and use in source and binary forms, with or without modification,\r\n * are permitted provided that the following conditions are met:\r\n *  * Redistributions of source code must retain the above copyright notice, this\r\n *  list of conditions and the following disclaimer.\r\n *  * Redistributions in binary form must reproduce the above copyright notice,\r\n *  this list of conditions and the following disclaimer in the documentation and/or\r\n *  other materials provided with the distribution.\r\n *  * Neither the name of Dash Industry Forum nor the names of its\r\n *  contributors may be used to endorse or promote products derived from this software\r\n *  without specific prior written permission.\r\n *\r\n *  THIS SOFTWARE IS PROVIDED BY THE COPYRIGHT HOLDERS AND CONTRIBUTORS AS IS AND ANY\r\n *  EXPRESS OR IMPLIED WARRANTIES, INCLUDING, BUT NOT LIMITED TO, THE IMPLIED\r\n *  WARRANTIES OF MERCHANTABILITY AND FITNESS FOR A PARTICULAR PURPOSE ARE DISCLAIMED.\r\n *  IN NO EVENT SHALL THE COPYRIGHT HOLDER OR CONTRIBUTORS BE LIABLE FOR ANY DIRECT,\r\n *  INDIRECT, INCIDENTAL, SPECIAL, EXEMPLARY, OR CONSEQUENTIAL DAMAGES (INCLUDING, BUT\r\n *  NOT LIMITED TO, PROCUREMENT OF SUBSTITUTE GOODS OR SERVICES; LOSS OF USE, DATA, OR\r\n *  PROFITS; OR BUSINESS INTERRUPTION) HOWEVER CAUSED AND ON ANY THEORY OF LIABILITY,\r\n *  WHETHER IN CONTRACT, STRICT LIABILITY, OR TORT (INCLUDING NEGLIGENCE OR OTHERWISE)\r\n *  ARISING IN ANY WAY OUT OF THE USE OF THIS SOFTWARE, EVEN IF ADVISED OF THE\r\n *  POSSIBILITY OF SUCH DAMAGE.\r\n */\r\n\r\nimport MetricSerialiser from '../../utils/MetricSerialiser';\r\nimport RNG from '../../utils/RNG';\r\n\r\nfunction DVBReporting(config) {\r\n    config = config || {};\r\n    let instance;\r\n\r\n    let context = this.context;\r\n    let metricSerialiser,\r\n        randomNumberGenerator,\r\n        reportingPlayerStatusDecided,\r\n        isReportingPlayer,\r\n        reportingUrl,\r\n        rangeController;\r\n\r\n    let USE_DRAFT_DVB_SPEC = true;\r\n    let allowPendingRequestsToCompleteOnReset = true;\r\n    let pendingRequests = [];\r\n\r\n    const metricsConstants = config.metricsConstants;\r\n\r\n    function setup() {\r\n        metricSerialiser = MetricSerialiser(context).getInstance();\r\n        randomNumberGenerator = RNG(context).getInstance();\r\n\r\n        resetInitialSettings();\r\n    }\r\n\r\n    function doGetRequest(url, successCB, failureCB) {\r\n        let req = new XMLHttpRequest();\r\n        const oncomplete = function () {\r\n            let reqIndex = pendingRequests.indexOf(req);\r\n\r\n            if (reqIndex === -1) {\r\n                return;\r\n            } else {\r\n                pendingRequests.splice(reqIndex, 1);\r\n            }\r\n\r\n            if ((req.status >= 200) && (req.status < 300)) {\r\n                if (successCB) {\r\n                    successCB();\r\n                }\r\n            } else {\r\n                if (failureCB) {\r\n                    failureCB();\r\n                }\r\n            }\r\n        };\r\n\r\n        pendingRequests.push(req);\r\n\r\n        try {\r\n            req.open('GET', url);\r\n            req.onloadend = oncomplete;\r\n            req.onerror = oncomplete;\r\n            req.send();\r\n        } catch (e) {\r\n            req.onerror();\r\n        }\r\n    }\r\n\r\n    function report(type, vos) {\r\n        if (!Array.isArray(vos)) {\r\n            vos = [vos];\r\n        }\r\n\r\n        // If the Player is not a reporting Player, then the Player shall\r\n        // not report any errors.\r\n        // ... In addition to any time restrictions specified by a Range\r\n        // element within the Metrics element.\r\n        if (isReportingPlayer && rangeController.isEnabled()) {\r\n\r\n            // This reporting mechanism operates by creating one HTTP GET\r\n            // request for every entry in the top level list of the metric.\r\n            vos.forEach(function (vo) {\r\n                let url = metricSerialiser.serialise(vo);\r\n\r\n                // this has been proposed for errata\r\n                if (USE_DRAFT_DVB_SPEC && (type !== metricsConstants.DVB_ERRORS)) {\r\n                    url = `metricname=${type}&${url}`;\r\n                }\r\n\r\n                // Take the value of the @reportingUrl attribute, append a\r\n                // question mark ('?') character and then append the string\r\n                // created in the previous step.\r\n                url = `${reportingUrl}?${url}`;\r\n\r\n                // Make an HTTP GET request to the URL contained within the\r\n                // string created in the previous step.\r\n                doGetRequest(url, null, function () {\r\n                    // If the Player is unable to make the report, for\r\n                    // example because the @reportingUrl is invalid, the\r\n                    // host cannot be reached, or an HTTP status code other\r\n                    // than one in the 200 series is received, the Player\r\n                    // shall cease being a reporting Player for the\r\n                    // duration of the MPD.\r\n                    isReportingPlayer = false;\r\n                });\r\n            });\r\n        }\r\n    }\r\n\r\n    function initialize(entry, rc) {\r\n        let probability;\r\n\r\n        rangeController = rc;\r\n\r\n        reportingUrl = entry.dvb_reportingUrl;\r\n\r\n        // If a required attribute is missing, the Reporting descriptor may\r\n        // be ignored by the Player\r\n        if (!reportingUrl) {\r\n            throw new Error(\r\n                'required parameter missing (dvb:reportingUrl)'\r\n            );\r\n        }\r\n\r\n        // A Player's status, as a reporting Player or not, shall remain\r\n        // static for the duration of the MPD, regardless of MPD updates.\r\n        // (i.e. only calling reset (or failure) changes this state)\r\n        if (!reportingPlayerStatusDecided) {\r\n            probability = entry.dvb_probability;\r\n            // TS 103 285 Clause 10.12.3.4\r\n            // If the @probability attribute is set to 1000, it shall be a reporting Player.\r\n            // If the @probability attribute is absent it will take the default value of 1000.\r\n            // For any other value of the @probability attribute, it shall decide at random whether to be a\r\n            // reporting Player, such that the probability of being one is @probability/1000.\r\n            if (probability && (probability === 1000 || ((probability / 1000) >= randomNumberGenerator.random()))) {\r\n                isReportingPlayer = true;\r\n            }\r\n\r\n            reportingPlayerStatusDecided = true;\r\n        }\r\n    }\r\n\r\n    function resetInitialSettings() {\r\n        reportingPlayerStatusDecided = false;\r\n        isReportingPlayer = false;\r\n        reportingUrl = null;\r\n        rangeController = null;\r\n    }\r\n\r\n    function reset() {\r\n        if (!allowPendingRequestsToCompleteOnReset) {\r\n            pendingRequests.forEach(req => req.abort());\r\n            pendingRequests = [];\r\n        }\r\n\r\n        resetInitialSettings();\r\n    }\r\n\r\n    instance = {\r\n        report:     report,\r\n        initialize: initialize,\r\n        reset:      reset\r\n    };\r\n\r\n    setup();\r\n\r\n    return instance;\r\n}\r\n\r\nDVBReporting.__dashjs_factory_name = 'DVBReporting';\r\nexport default dashjs.FactoryMaker.getClassFactory(DVBReporting); /* jshint ignore:line */\r\n"]}