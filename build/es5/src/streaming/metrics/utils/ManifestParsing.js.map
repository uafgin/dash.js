{"version":3,"sources":["../../../../../../src/streaming/metrics/utils/ManifestParsing.js"],"names":["ManifestParsing","config","instance","adapter","constants","getMetricsRangeStartTime","manifest","dynamic","range","voPeriods","reportingStartTime","presentationStartTime","getAvailabilityStartTime","getRegularPeriods","length","start","hasOwnProperty","START_TIME","starttime","getMetrics","metrics","Metrics_asArray","forEach","metricEntry","Metrics","isDynamic","getIsDynamic","metric","Range_asArray","rangeEntry","Range","duration","getDuration","_useWallClockTime","push","Reporting_asArray","reportingEntry","Reporting","reporting","SCHEME_ID_URI","schemeIdUri","value","DVB_REPORTING_URL","dvb_reportingUrl","DVB_PROBABILITY","dvb_probability","__dashjs_factory_name","dashjs","FactoryMaker","getSingletonFactory"],"mappings":"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","file":"ManifestParsing.js","sourcesContent":["import Metrics from '../vo/Metrics';\r\nimport Range from '../vo/Range';\r\nimport Reporting from '../vo/Reporting';\r\n\r\nfunction ManifestParsing (config) {\r\n    config = config || {};\r\n    let instance;\r\n    let adapter = config.adapter;\r\n    const constants = config.constants;\r\n\r\n    function getMetricsRangeStartTime(manifest, dynamic, range) {\r\n        let voPeriods,\r\n            reportingStartTime;\r\n        let presentationStartTime = 0;\r\n\r\n        if (dynamic) {\r\n            // For services with MPD@type='dynamic', the start time is\r\n            // indicated in wall clock time by adding the value of this\r\n            // attribute to the value of the MPD@availabilityStartTime\r\n            // attribute.\r\n            presentationStartTime = adapter.getAvailabilityStartTime(manifest) / 1000;\r\n        } else {\r\n            // For services with MPD@type='static', the start time is indicated\r\n            // in Media Presentation time and is relative to the PeriodStart\r\n            // time of the first Period in this MPD.\r\n            voPeriods = adapter.getRegularPeriods(manifest);\r\n\r\n            if (voPeriods.length) {\r\n                presentationStartTime = voPeriods[0].start;\r\n            }\r\n        }\r\n\r\n        // When not present, DASH Metrics collection is\r\n        // requested from the beginning of content\r\n        // consumption.\r\n        reportingStartTime = presentationStartTime;\r\n\r\n        if (range && range.hasOwnProperty(constants.START_TIME)) {\r\n            reportingStartTime += range.starttime;\r\n        }\r\n\r\n        return reportingStartTime;\r\n    }\r\n\r\n    function getMetrics(manifest) {\r\n        let metrics = [];\r\n\r\n        if (manifest && manifest.Metrics_asArray) {\r\n            manifest.Metrics_asArray.forEach(metric => {\r\n                var metricEntry = new Metrics();\r\n                var isDynamic = adapter.getIsDynamic(manifest);\r\n\r\n                if (metric.hasOwnProperty('metrics')) {\r\n                    metricEntry.metrics = metric.metrics;\r\n                } else {\r\n                    return;\r\n                }\r\n\r\n                if (metric.Range_asArray) {\r\n                    metric.Range_asArray.forEach(range => {\r\n                        var rangeEntry = new Range();\r\n\r\n                        rangeEntry.starttime =\r\n                            getMetricsRangeStartTime(manifest, isDynamic, range);\r\n\r\n                        if (range.hasOwnProperty('duration')) {\r\n                            rangeEntry.duration = range.duration;\r\n                        } else {\r\n                            // if not present, the value is identical to the\r\n                            // Media Presentation duration.\r\n                            rangeEntry.duration = adapter.getDuration(manifest);\r\n                        }\r\n\r\n                        rangeEntry._useWallClockTime = isDynamic;\r\n\r\n                        metricEntry.Range.push(rangeEntry);\r\n                    });\r\n                }\r\n\r\n                if (metric.Reporting_asArray) {\r\n                    metric.Reporting_asArray.forEach(reporting => {\r\n                        var reportingEntry = new Reporting();\r\n\r\n                        if (reporting.hasOwnProperty(constants.SCHEME_ID_URI)) {\r\n                            reportingEntry.schemeIdUri = reporting.schemeIdUri;\r\n                        } else {\r\n                            // Invalid Reporting. schemeIdUri must be set. Ignore.\r\n                            return;\r\n                        }\r\n\r\n                        if (reporting.hasOwnProperty('value')) {\r\n                            reportingEntry.value = reporting.value;\r\n                        }\r\n\r\n                        if (reporting.hasOwnProperty(constants.DVB_REPORTING_URL)) {\r\n                            reportingEntry.dvb_reportingUrl = reporting[constants.DVB_REPORTING_URL];\r\n                        }\r\n\r\n                        if (reporting.hasOwnProperty(constants.DVB_PROBABILITY)) {\r\n                            reportingEntry.dvb_probability = reporting[constants.DVB_PROBABILITY];\r\n                        }\r\n\r\n                        metricEntry.Reporting.push(reportingEntry);\r\n                    });\r\n                } else {\r\n                    // Invalid Metrics. At least one reporting must be present. Ignore\r\n                    return;\r\n                }\r\n\r\n                metrics.push(metricEntry);\r\n            });\r\n        }\r\n\r\n        return metrics;\r\n    }\r\n\r\n    instance = {\r\n        getMetrics: getMetrics\r\n    };\r\n\r\n    return instance;\r\n}\r\n\r\nManifestParsing.__dashjs_factory_name = 'ManifestParsing';\r\nexport default dashjs.FactoryMaker.getSingletonFactory(ManifestParsing); /* jshint ignore:line */"]}