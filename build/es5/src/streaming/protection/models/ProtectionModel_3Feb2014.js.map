{"version":3,"sources":["../../../../../../src/streaming/protection/models/ProtectionModel_3Feb2014.js"],"names":["ProtectionModel_3Feb2014","config","context","eventBus","events","debug","api","instance","logger","videoElement","keySystem","mediaKeys","keySystemAccess","sessions","eventHandler","protectionKeyController","setup","getLogger","getInstance","createEventHandler","reset","i","length","closeKeySession","removeEventListener","needkey","trigger","TEARDOWN_COMPLETE","error","message","getKeySystem","getAllInitData","retVal","push","initData","requestKeySystemAccess","ksConfigurations","found","ksIdx","systemString","ks","configs","supportedAudio","supportedVideo","configIdx","audios","audioCapabilities","videos","videoCapabilities","audioIdx","window","MediaKeys","isTypeSupported","contentType","videoIdx","ksConfig","KeySystemConfiguration","getKeySystemBySystemString","KEY_SYSTEM_ACCESS_COMPLETE","data","KeySystemAccess","selectKeySystem","ksAccess","setMediaKeys","INTERNAL_KEY_SYSTEM_SELECTED","setMediaElement","mediaElement","addEventListener","createKeySession","protData","sessionType","cdmData","Error","capabilities","ksConfiguration","session","createSession","Uint8Array","sessionToken","createSessionToken","ready","close","getSessionID","KEY_SESSION_CREATED","updateKeySession","isClearKey","update","toJWK","splice","release","setServerCertificate","loadKeySession","removeKeySession","handleEvent","event","type","ArrayBuffer","isView","buffer","NEED_KEY","key","NeedKey","boundDoSetKeys","doSetKeys","VIDEO_ELEMENT_SELECTED","readyState","bind","keySession","sessionId","getExpirationTime","NaN","getSessionType","errorStr","KEY_ERROR","DashJSError","ProtectionErrors","MEDIA_KEYERR_CODE","INTERNAL_KEY_MESSAGE","KeyMessage","destinationURL","KEY_ADDED","KEY_SESSION_CLOSED","stop","__dashjs_factory_name","dashjs","FactoryMaker","getClassFactory"],"mappings":"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","file":"ProtectionModel_3Feb2014.js","sourcesContent":["/**\r\n * The copyright in this software is being made available under the BSD License,\r\n * included below. This software may be subject to other third party and contributor\r\n * rights, including patent rights, and no such rights are granted under this license.\r\n *\r\n * Copyright (c) 2013, Dash Industry Forum.\r\n * All rights reserved.\r\n *\r\n * Redistribution and use in source and binary forms, with or without modification,\r\n * are permitted provided that the following conditions are met:\r\n *  * Redistributions of source code must retain the above copyright notice, this\r\n *  list of conditions and the following disclaimer.\r\n *  * Redistributions in binary form must reproduce the above copyright notice,\r\n *  this list of conditions and the following disclaimer in the documentation and/or\r\n *  other materials provided with the distribution.\r\n *  * Neither the name of Dash Industry Forum nor the names of its\r\n *  contributors may be used to endorse or promote products derived from this software\r\n *  without specific prior written permission.\r\n *\r\n *  THIS SOFTWARE IS PROVIDED BY THE COPYRIGHT HOLDERS AND CONTRIBUTORS AS IS AND ANY\r\n *  EXPRESS OR IMPLIED WARRANTIES, INCLUDING, BUT NOT LIMITED TO, THE IMPLIED\r\n *  WARRANTIES OF MERCHANTABILITY AND FITNESS FOR A PARTICULAR PURPOSE ARE DISCLAIMED.\r\n *  IN NO EVENT SHALL THE COPYRIGHT HOLDER OR CONTRIBUTORS BE LIABLE FOR ANY DIRECT,\r\n *  INDIRECT, INCIDENTAL, SPECIAL, EXEMPLARY, OR CONSEQUENTIAL DAMAGES (INCLUDING, BUT\r\n *  NOT LIMITED TO, PROCUREMENT OF SUBSTITUTE GOODS OR SERVICES; LOSS OF USE, DATA, OR\r\n *  PROFITS; OR BUSINESS INTERRUPTION) HOWEVER CAUSED AND ON ANY THEORY OF LIABILITY,\r\n *  WHETHER IN CONTRACT, STRICT LIABILITY, OR TORT (INCLUDING NEGLIGENCE OR OTHERWISE)\r\n *  ARISING IN ANY WAY OUT OF THE USE OF THIS SOFTWARE, EVEN IF ADVISED OF THE\r\n *  POSSIBILITY OF SUCH DAMAGE.\r\n */\r\n\r\n/**\r\n * Implementation of the EME APIs as of the 3 Feb 2014 state of the specification.\r\n *\r\n * Implemented by Internet Explorer 11 (Windows 8.1)\r\n *\r\n * @implements ProtectionModel\r\n * @class\r\n */\r\n\r\nimport ProtectionKeyController from '../controllers/ProtectionKeyController';\r\nimport NeedKey from '../vo/NeedKey';\r\nimport DashJSError from '../../vo/DashJSError';\r\nimport ProtectionErrors from '../errors/ProtectionErrors';\r\nimport KeyMessage from '../vo/KeyMessage';\r\nimport KeySystemConfiguration from '../vo/KeySystemConfiguration';\r\nimport KeySystemAccess from '../vo/KeySystemAccess';\r\n\r\nfunction ProtectionModel_3Feb2014(config) {\r\n\r\n    config = config || {};\r\n    const context = this.context;\r\n    const eventBus = config.eventBus;//Need to pass in here so we can use same instance since this is optional module\r\n    const events = config.events;\r\n    const debug = config.debug;\r\n    const api = config.api;\r\n\r\n    let instance,\r\n        logger,\r\n        videoElement,\r\n        keySystem,\r\n        mediaKeys,\r\n        keySystemAccess,\r\n        sessions,\r\n        eventHandler,\r\n        protectionKeyController;\r\n\r\n    function setup() {\r\n        logger = debug.getLogger(instance);\r\n        videoElement = null;\r\n        keySystem = null;\r\n        mediaKeys = null;\r\n        keySystemAccess = null;\r\n        sessions = [];\r\n        protectionKeyController = ProtectionKeyController(context).getInstance();\r\n        eventHandler = createEventHandler();\r\n    }\r\n\r\n    function reset() {\r\n        try {\r\n            for (let i = 0; i < sessions.length; i++) {\r\n                closeKeySession(sessions[i]);\r\n            }\r\n            if (videoElement) {\r\n                videoElement.removeEventListener(api.needkey, eventHandler);\r\n            }\r\n            eventBus.trigger(events.TEARDOWN_COMPLETE);\r\n        } catch (error) {\r\n            eventBus.trigger(events.TEARDOWN_COMPLETE, { error: 'Error tearing down key sessions and MediaKeys! -- ' + error.message });\r\n        }\r\n    }\r\n\r\n    function getKeySystem() {\r\n        return keySystem;\r\n    }\r\n\r\n    function getAllInitData() {\r\n        const retVal = [];\r\n        for (let i = 0; i < sessions.length; i++) {\r\n            retVal.push(sessions[i].initData);\r\n        }\r\n        return retVal;\r\n    }\r\n\r\n    function requestKeySystemAccess(ksConfigurations) {\r\n\r\n        // Try key systems in order, first one with supported key system configuration\r\n        // is used\r\n        let found = false;\r\n        for (let ksIdx = 0; ksIdx < ksConfigurations.length; ksIdx++) {\r\n            const systemString = ksConfigurations[ksIdx].ks.systemString;\r\n            const configs = ksConfigurations[ksIdx].configs;\r\n            let supportedAudio = null;\r\n            let supportedVideo = null;\r\n\r\n            // Try key system configs in order, first one with supported audio/video\r\n            // is used\r\n            for (let configIdx = 0; configIdx < configs.length; configIdx++) {\r\n                const audios = configs[configIdx].audioCapabilities;\r\n                const videos = configs[configIdx].videoCapabilities;\r\n\r\n                // Look for supported audio container/codecs\r\n                if (audios && audios.length !== 0) {\r\n                    supportedAudio = []; // Indicates that we have a requested audio config\r\n                    for (let audioIdx = 0; audioIdx < audios.length; audioIdx++) {\r\n                        if (window[api.MediaKeys].isTypeSupported(systemString, audios[audioIdx].contentType)) {\r\n                            supportedAudio.push(audios[audioIdx]);\r\n                        }\r\n                    }\r\n                }\r\n\r\n                // Look for supported video container/codecs\r\n                if (videos && videos.length !== 0) {\r\n                    supportedVideo = []; // Indicates that we have a requested video config\r\n                    for (let videoIdx = 0; videoIdx < videos.length; videoIdx++) {\r\n                        if (window[api.MediaKeys].isTypeSupported(systemString, videos[videoIdx].contentType)) {\r\n                            supportedVideo.push(videos[videoIdx]);\r\n                        }\r\n                    }\r\n                }\r\n\r\n                // No supported audio or video in this configuration OR we have\r\n                // requested audio or video configuration that is not supported\r\n                if ((!supportedAudio && !supportedVideo) ||\r\n                    (supportedAudio && supportedAudio.length === 0) ||\r\n                    (supportedVideo && supportedVideo.length === 0)) {\r\n                    continue;\r\n                }\r\n\r\n                // This configuration is supported\r\n                found = true;\r\n                const ksConfig = new KeySystemConfiguration(supportedAudio, supportedVideo);\r\n                const ks = protectionKeyController.getKeySystemBySystemString(systemString);\r\n                eventBus.trigger(events.KEY_SYSTEM_ACCESS_COMPLETE, { data: new KeySystemAccess(ks, ksConfig) });\r\n                break;\r\n            }\r\n        }\r\n        if (!found) {\r\n            eventBus.trigger(events.KEY_SYSTEM_ACCESS_COMPLETE, { error: 'Key system access denied! -- No valid audio/video content configurations detected!' });\r\n        }\r\n    }\r\n\r\n    function selectKeySystem(ksAccess) {\r\n        try {\r\n            mediaKeys = ksAccess.mediaKeys = new window[api.MediaKeys](ksAccess.keySystem.systemString);\r\n            keySystem = ksAccess.keySystem;\r\n            keySystemAccess = ksAccess;\r\n            if (videoElement) {\r\n                setMediaKeys();\r\n            }\r\n            eventBus.trigger(events.INTERNAL_KEY_SYSTEM_SELECTED);\r\n        } catch (error) {\r\n            eventBus.trigger(events.INTERNAL_KEY_SYSTEM_SELECTED, { error: 'Error selecting keys system (' + keySystem.systemString + ')! Could not create MediaKeys -- TODO' });\r\n        }\r\n    }\r\n\r\n    function setMediaElement(mediaElement) {\r\n        if (videoElement === mediaElement)\r\n            return;\r\n\r\n        // Replacing the previous element\r\n        if (videoElement) {\r\n            videoElement.removeEventListener(api.needkey, eventHandler);\r\n        }\r\n\r\n        videoElement = mediaElement;\r\n\r\n        // Only if we are not detaching from the existing element\r\n        if (videoElement) {\r\n            videoElement.addEventListener(api.needkey, eventHandler);\r\n            if (mediaKeys) {\r\n                setMediaKeys();\r\n            }\r\n        }\r\n    }\r\n\r\n    function createKeySession(initData, protData, sessionType, cdmData) {\r\n        if (!keySystem || !mediaKeys || !keySystemAccess) {\r\n            throw new Error('Can not create sessions until you have selected a key system');\r\n        }\r\n\r\n        // Use the first video capability for the contentType.\r\n        // TODO:  Not sure if there is a way to concatenate all capability data into a RFC6386-compatible format\r\n\r\n        // If player is trying to playback Audio only stream - don't error out.\r\n        let capabilities = null;\r\n\r\n        if (keySystemAccess.ksConfiguration.videoCapabilities && keySystemAccess.ksConfiguration.videoCapabilities.length > 0) {\r\n            capabilities = keySystemAccess.ksConfiguration.videoCapabilities[0];\r\n        }\r\n\r\n        if (capabilities === null && keySystemAccess.ksConfiguration.audioCapabilities && keySystemAccess.ksConfiguration.audioCapabilities.length > 0) {\r\n            capabilities = keySystemAccess.ksConfiguration.audioCapabilities[0];\r\n        }\r\n\r\n        if (capabilities === null) {\r\n            throw new Error('Can not create sessions for unknown content types.');\r\n        }\r\n\r\n        const contentType = capabilities.contentType;\r\n        const session = mediaKeys.createSession(contentType, new Uint8Array(initData), cdmData ? new Uint8Array(cdmData) : null);\r\n        const sessionToken = createSessionToken(session, initData);\r\n\r\n        // Add all event listeners\r\n        session.addEventListener(api.error, sessionToken);\r\n        session.addEventListener(api.message, sessionToken);\r\n        session.addEventListener(api.ready, sessionToken);\r\n        session.addEventListener(api.close, sessionToken);\r\n\r\n        // Add to our session list\r\n        sessions.push(sessionToken);\r\n        logger.debug('DRM: Session created.  SessionID = ' + sessionToken.getSessionID());\r\n        eventBus.trigger(events.KEY_SESSION_CREATED, { data: sessionToken });\r\n    }\r\n\r\n    function updateKeySession(sessionToken, message) {\r\n        const session = sessionToken.session;\r\n\r\n        if (!protectionKeyController.isClearKey(keySystem)) {\r\n            // Send our request to the key session\r\n            session.update(new Uint8Array(message));\r\n        } else {\r\n            // For clearkey, message is a ClearKeyKeySet\r\n            session.update(new Uint8Array(message.toJWK()));\r\n        }\r\n    }\r\n\r\n    /**\r\n     * Close the given session and release all associated keys.  Following\r\n     * this call, the sessionToken becomes invalid\r\n     *\r\n     * @param {Object} sessionToken - the session token\r\n     */\r\n    function closeKeySession(sessionToken) {\r\n        const session = sessionToken.session;\r\n\r\n        // Remove event listeners\r\n        session.removeEventListener(api.error, sessionToken);\r\n        session.removeEventListener(api.message, sessionToken);\r\n        session.removeEventListener(api.ready, sessionToken);\r\n        session.removeEventListener(api.close, sessionToken);\r\n\r\n        // Remove from our session list\r\n        for (let i = 0; i < sessions.length; i++) {\r\n            if (sessions[i] === sessionToken) {\r\n                sessions.splice(i, 1);\r\n                break;\r\n            }\r\n        }\r\n\r\n        // Send our request to the key session\r\n        session[api.release]();\r\n    }\r\n\r\n    function setServerCertificate(/*serverCertificate*/) { /* Not supported */ }\r\n    function loadKeySession(/*sessionID*/) { /* Not supported */ }\r\n    function removeKeySession(/*sessionToken*/) { /* Not supported */ }\r\n\r\n\r\n    function createEventHandler() {\r\n        return {\r\n            handleEvent: function (event) {\r\n                switch (event.type) {\r\n\r\n                    case api.needkey:\r\n                        if (event.initData) {\r\n                            const initData = ArrayBuffer.isView(event.initData) ? event.initData.buffer : event.initData;\r\n                            eventBus.trigger(events.NEED_KEY, { key: new NeedKey(initData, 'cenc') });\r\n                        }\r\n                        break;\r\n                }\r\n            }\r\n        };\r\n    }\r\n\r\n\r\n    // IE11 does not let you set MediaKeys until it has entered a certain\r\n    // readyState, so we need this logic to ensure we don't set the keys\r\n    // too early\r\n    function setMediaKeys() {\r\n        let boundDoSetKeys = null;\r\n        const doSetKeys = function () {\r\n            videoElement.removeEventListener('loadedmetadata', boundDoSetKeys);\r\n            videoElement[api.setMediaKeys](mediaKeys);\r\n            eventBus.trigger(events.VIDEO_ELEMENT_SELECTED);\r\n        };\r\n        if (videoElement.readyState >= 1) {\r\n            doSetKeys();\r\n        } else {\r\n            boundDoSetKeys = doSetKeys.bind(this);\r\n            videoElement.addEventListener('loadedmetadata', boundDoSetKeys);\r\n        }\r\n\r\n    }\r\n\r\n    // Function to create our session token objects which manage the EME\r\n    // MediaKeySession and session-specific event handler\r\n    function createSessionToken(keySession, initData) {\r\n        return {\r\n            // Implements SessionToken\r\n            session: keySession,\r\n            initData: initData,\r\n\r\n            getSessionID: function () {\r\n                return this.session.sessionId;\r\n            },\r\n\r\n            getExpirationTime: function () {\r\n                return NaN;\r\n            },\r\n\r\n            getSessionType: function () {\r\n                return 'temporary';\r\n            },\r\n            // This is our main event handler for all desired MediaKeySession events\r\n            // These events are translated into our API-independent versions of the\r\n            // same events\r\n            handleEvent: function (event) {\r\n                switch (event.type) {\r\n                    case api.error:\r\n                        let errorStr = 'KeyError'; // TODO: Make better string from event\r\n                        eventBus.trigger(events.KEY_ERROR, { data: new DashJSError(ProtectionErrors.MEDIA_KEYERR_CODE, errorStr, this) });\r\n                        break;\r\n                    case api.message:\r\n                        let message = ArrayBuffer.isView(event.message) ? event.message.buffer : event.message;\r\n                        eventBus.trigger(events.INTERNAL_KEY_MESSAGE, { data: new KeyMessage(this, message, event.destinationURL) });\r\n                        break;\r\n                    case api.ready:\r\n                        logger.debug('DRM: Key added.');\r\n                        eventBus.trigger(events.KEY_ADDED);\r\n                        break;\r\n\r\n                    case api.close:\r\n                        logger.debug('DRM: Session closed.  SessionID = ' + this.getSessionID());\r\n                        eventBus.trigger(events.KEY_SESSION_CLOSED, { data: this.getSessionID() });\r\n                        break;\r\n                }\r\n            }\r\n        };\r\n    }\r\n\r\n    instance = {\r\n        getAllInitData: getAllInitData,\r\n        requestKeySystemAccess: requestKeySystemAccess,\r\n        getKeySystem: getKeySystem,\r\n        selectKeySystem: selectKeySystem,\r\n        setMediaElement: setMediaElement,\r\n        createKeySession: createKeySession,\r\n        updateKeySession: updateKeySession,\r\n        closeKeySession: closeKeySession,\r\n        setServerCertificate: setServerCertificate,\r\n        loadKeySession: loadKeySession,\r\n        removeKeySession: removeKeySession,\r\n        stop: reset,\r\n        reset: reset\r\n    };\r\n\r\n    setup();\r\n\r\n    return instance;\r\n}\r\n\r\nProtectionModel_3Feb2014.__dashjs_factory_name = 'ProtectionModel_3Feb2014';\r\nexport default dashjs.FactoryMaker.getClassFactory(ProtectionModel_3Feb2014); /* jshint ignore:line */\r\n"]}