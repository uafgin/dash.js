{"version":3,"sources":["../../../../../src/streaming/protection/Protection.js"],"names":["APIS_ProtectionModel_01b","generateKeyRequest","addKey","cancelKeyRequest","needkey","keyerror","keyadded","keymessage","APIS_ProtectionModel_3Feb2014","setMediaKeys","MediaKeys","release","error","message","ready","close","Protection","instance","context","createProtectionSystem","config","controller","protectionKeyController","getInstance","setConfig","debug","BASE64","initialize","protectionModel","getProtectionModel","create","eventBus","events","constants","cmcdModel","capabilities","setEncryptedMediaSupported","logger","getLogger","errHandler","videoElement","videoModel","getElement","onencrypted","undefined","mediaKeys","info","getAPI","api","warn","apis","i","length","Object","keys","__dashjs_factory_name","factory","dashjs","FactoryMaker","getClassFactory","ProtectionEvents","errors","ProtectionErrors","updateClassFactory"],"mappings":"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","file":"Protection.js","sourcesContent":["/**\r\n * The copyright in this software is being made available under the BSD License,\r\n * included below. This software may be subject to other third party and contributor\r\n * rights, including patent rights, and no such rights are granted under this license.\r\n *\r\n * Copyright (c) 2013, Dash Industry Forum.\r\n * All rights reserved.\r\n *\r\n * Redistribution and use in source and binary forms, with or without modification,\r\n * are permitted provided that the following conditions are met:\r\n *  * Redistributions of source code must retain the above copyright notice, this\r\n *  list of conditions and the following disclaimer.\r\n *  * Redistributions in binary form must reproduce the above copyright notice,\r\n *  this list of conditions and the following disclaimer in the documentation and/or\r\n *  other materials provided with the distribution.\r\n *  * Neither the name of Dash Industry Forum nor the names of its\r\n *  contributors may be used to endorse or promote products derived from this software\r\n *  without specific prior written permission.\r\n *\r\n *  THIS SOFTWARE IS PROVIDED BY THE COPYRIGHT HOLDERS AND CONTRIBUTORS AS IS AND ANY\r\n *  EXPRESS OR IMPLIED WARRANTIES, INCLUDING, BUT NOT LIMITED TO, THE IMPLIED\r\n *  WARRANTIES OF MERCHANTABILITY AND FITNESS FOR A PARTICULAR PURPOSE ARE DISCLAIMED.\r\n *  IN NO EVENT SHALL THE COPYRIGHT HOLDER OR CONTRIBUTORS BE LIABLE FOR ANY DIRECT,\r\n *  INDIRECT, INCIDENTAL, SPECIAL, EXEMPLARY, OR CONSEQUENTIAL DAMAGES (INCLUDING, BUT\r\n *  NOT LIMITED TO, PROCUREMENT OF SUBSTITUTE GOODS OR SERVICES; LOSS OF USE, DATA, OR\r\n *  PROFITS; OR BUSINESS INTERRUPTION) HOWEVER CAUSED AND ON ANY THEORY OF LIABILITY,\r\n *  WHETHER IN CONTRACT, STRICT LIABILITY, OR TORT (INCLUDING NEGLIGENCE OR OTHERWISE)\r\n *  ARISING IN ANY WAY OUT OF THE USE OF THIS SOFTWARE, EVEN IF ADVISED OF THE\r\n *  POSSIBILITY OF SUCH DAMAGE.\r\n */\r\nimport ProtectionController from './controllers/ProtectionController';\r\nimport ProtectionKeyController from './controllers/ProtectionKeyController';\r\nimport ProtectionEvents from './ProtectionEvents';\r\nimport ProtectionErrors from './errors/ProtectionErrors';\r\nimport ProtectionModel_21Jan2015 from './models/ProtectionModel_21Jan2015';\r\nimport ProtectionModel_3Feb2014 from './models/ProtectionModel_3Feb2014';\r\nimport ProtectionModel_01b from './models/ProtectionModel_01b';\r\n\r\nconst APIS_ProtectionModel_01b = [\r\n    // Un-prefixed as per spec\r\n    {\r\n        // Video Element\r\n        generateKeyRequest: 'generateKeyRequest',\r\n        addKey: 'addKey',\r\n        cancelKeyRequest: 'cancelKeyRequest',\r\n\r\n        // Events\r\n        needkey: 'needkey',\r\n        keyerror: 'keyerror',\r\n        keyadded: 'keyadded',\r\n        keymessage: 'keymessage'\r\n    },\r\n    // Webkit-prefixed (early Chrome versions and Chrome with EME disabled in chrome://flags)\r\n    {\r\n        // Video Element\r\n        generateKeyRequest: 'webkitGenerateKeyRequest',\r\n        addKey: 'webkitAddKey',\r\n        cancelKeyRequest: 'webkitCancelKeyRequest',\r\n\r\n        // Events\r\n        needkey: 'webkitneedkey',\r\n        keyerror: 'webkitkeyerror',\r\n        keyadded: 'webkitkeyadded',\r\n        keymessage: 'webkitkeymessage'\r\n    }\r\n];\r\n\r\nconst APIS_ProtectionModel_3Feb2014 = [\r\n    // Un-prefixed as per spec\r\n    // Chrome 38-39 (and some earlier versions) with chrome://flags -- Enable Encrypted Media Extensions\r\n    {\r\n        // Video Element\r\n        setMediaKeys: 'setMediaKeys',\r\n        // MediaKeys\r\n        MediaKeys: 'MediaKeys',\r\n        // MediaKeySession\r\n        release: 'close',\r\n\r\n        // Events\r\n        needkey: 'needkey',\r\n        error: 'keyerror',\r\n        message: 'keymessage',\r\n        ready: 'keyadded',\r\n        close: 'keyclose'\r\n    },\r\n    // MS-prefixed (IE11, Windows 8.1)\r\n    {\r\n        // Video Element\r\n        setMediaKeys: 'msSetMediaKeys',\r\n        // MediaKeys\r\n        MediaKeys: 'MSMediaKeys',\r\n        // MediaKeySession\r\n        release: 'close',\r\n        // Events\r\n        needkey: 'msneedkey',\r\n        error: 'mskeyerror',\r\n        message: 'mskeymessage',\r\n        ready: 'mskeyadded',\r\n        close: 'mskeyclose'\r\n    }\r\n];\r\n\r\nfunction Protection() {\r\n    let instance;\r\n    const context = this.context;\r\n\r\n    /**\r\n     * Create a ProtectionController and associated ProtectionModel for use with\r\n     * a single piece of content.\r\n     *\r\n     * @param {Object} config\r\n     * @return {ProtectionController} protection controller\r\n     *\r\n     */\r\n    function createProtectionSystem(config) {\r\n        let controller = null;\r\n\r\n        const protectionKeyController = ProtectionKeyController(context).getInstance();\r\n        protectionKeyController.setConfig({ debug: config.debug, BASE64: config.BASE64 });\r\n        protectionKeyController.initialize();\r\n\r\n        let protectionModel =  getProtectionModel(config);\r\n\r\n        if (!controller && protectionModel) {//TODO add ability to set external controller if still needed at all?\r\n            controller = ProtectionController(context).create({\r\n                protectionModel: protectionModel,\r\n                protectionKeyController: protectionKeyController,\r\n                eventBus: config.eventBus,\r\n                debug: config.debug,\r\n                events: config.events,\r\n                BASE64: config.BASE64,\r\n                constants: config.constants,\r\n                cmcdModel: config.cmcdModel\r\n            });\r\n            config.capabilities.setEncryptedMediaSupported(true);\r\n        }\r\n        return controller;\r\n    }\r\n\r\n    function getProtectionModel(config) {\r\n        const debug = config.debug;\r\n        const logger = debug.getLogger(instance);\r\n        const eventBus = config.eventBus;\r\n        const errHandler = config.errHandler;\r\n        const videoElement = config.videoModel ? config.videoModel.getElement() : null;\r\n\r\n        if ((!videoElement || videoElement.onencrypted !== undefined) &&\r\n            (!videoElement || videoElement.mediaKeys !== undefined)) {\r\n            logger.info('EME detected on this user agent! (ProtectionModel_21Jan2015)');\r\n            return ProtectionModel_21Jan2015(context).create({ debug: debug, eventBus: eventBus, events: config.events });\r\n        } else if (getAPI(videoElement, APIS_ProtectionModel_3Feb2014)) {\r\n            logger.info('EME detected on this user agent! (ProtectionModel_3Feb2014)');\r\n            return ProtectionModel_3Feb2014(context).create({ debug: debug, eventBus: eventBus, events: config.events, api: getAPI(videoElement, APIS_ProtectionModel_3Feb2014) });\r\n        } else if (getAPI(videoElement, APIS_ProtectionModel_01b)) {\r\n            logger.info('EME detected on this user agent! (ProtectionModel_01b)');\r\n            return ProtectionModel_01b(context).create({ debug: debug, eventBus: eventBus, errHandler: errHandler, events: config.events, api: getAPI(videoElement, APIS_ProtectionModel_01b) });\r\n        } else {\r\n            logger.warn('No supported version of EME detected on this user agent! - Attempts to play encrypted content will fail!');\r\n            return null;\r\n        }\r\n    }\r\n\r\n    function getAPI(videoElement, apis) {\r\n        for (let i = 0; i < apis.length; i++) {\r\n            const api = apis[i];\r\n            // detect if api is supported by browser\r\n            // check only first function in api -> should be fine\r\n            if (typeof videoElement[api[Object.keys(api)[0]]] !== 'function') {\r\n                continue;\r\n            }\r\n\r\n            return api;\r\n        }\r\n\r\n        return null;\r\n    }\r\n\r\n    instance = {\r\n        createProtectionSystem: createProtectionSystem\r\n    };\r\n\r\n    return instance;\r\n}\r\n\r\nProtection.__dashjs_factory_name = 'Protection';\r\nconst factory = dashjs.FactoryMaker.getClassFactory(Protection); /* jshint ignore:line */\r\nfactory.events = ProtectionEvents;\r\nfactory.errors = ProtectionErrors;\r\ndashjs.FactoryMaker.updateClassFactory(Protection.__dashjs_factory_name, factory); /* jshint ignore:line */\r\nexport default factory;\r\n"]}