{"version":3,"sources":["../../../../../src/streaming/utils/CapabilitiesFilter.js"],"names":["CapabilitiesFilter","context","instance","adapter","capabilities","settings","logger","setup","getInstance","getLogger","setConfig","config","filterUnsupportedFeaturesOfPeriod","streamInfo","_filterUnsupportedCodecs","Constants","VIDEO","AUDIO","get","streaming","filterUnsupportedEssentialProperties","_filterUnsupportedEssentialProperties","type","realPeriod","getRealPeriodByIndex","index","AdaptationSet_asArray","length","filter","as","Representation_asArray","getIsTypeOf","_","i","codec","getCodec","supportsCodec","error","rep","essentialProperties","getEssentialPropertiesForRepresentation","supportsEssentialProperty","debug","schemeIdUri","__dashjs_factory_name","FactoryMaker","getSingletonFactory"],"mappings":"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","file":"CapabilitiesFilter.js","sourcesContent":["import FactoryMaker from '../../core/FactoryMaker';\r\nimport Debug from '../../core/Debug';\r\nimport Constants from '../constants/Constants';\r\n\r\nfunction CapabilitiesFilter() {\r\n    const context = this.context;\r\n    let instance,\r\n        adapter,\r\n        capabilities,\r\n        settings,\r\n        logger;\r\n\r\n\r\n    function setup() {\r\n        logger = Debug(context).getInstance().getLogger(instance);\r\n    }\r\n\r\n    function setConfig(config) {\r\n        if (!config) {\r\n            return;\r\n        }\r\n\r\n        if (config.adapter) {\r\n            adapter = config.adapter;\r\n        }\r\n\r\n        if (config.capabilities) {\r\n            capabilities = config.capabilities;\r\n        }\r\n\r\n        if (config.settings) {\r\n            settings = config.settings;\r\n        }\r\n\r\n    }\r\n\r\n    function filterUnsupportedFeaturesOfPeriod(streamInfo) {\r\n        _filterUnsupportedCodecs(Constants.VIDEO, streamInfo);\r\n        _filterUnsupportedCodecs(Constants.AUDIO, streamInfo);\r\n\r\n        if (settings.get().streaming.filterUnsupportedEssentialProperties) {\r\n            _filterUnsupportedEssentialProperties(streamInfo);\r\n        }\r\n    }\r\n\r\n\r\n    function _filterUnsupportedCodecs(type, streamInfo) {\r\n        const realPeriod = adapter.getRealPeriodByIndex(streamInfo ? streamInfo.index : null);\r\n\r\n        if (!realPeriod || !realPeriod.AdaptationSet_asArray || realPeriod.AdaptationSet_asArray.length === 0) {\r\n            return;\r\n        }\r\n\r\n        realPeriod.AdaptationSet_asArray = realPeriod.AdaptationSet_asArray.filter((as) => {\r\n\r\n            if (!as.Representation_asArray || as.Representation_asArray.length === 0 || !adapter.getIsTypeOf(as, type)) {\r\n                return true;\r\n            }\r\n\r\n            as.Representation_asArray = as.Representation_asArray.filter((_, i) => {\r\n                const codec = adapter.getCodec(as, i, true);\r\n                if (!capabilities.supportsCodec(codec)) {\r\n                    logger.error('[Stream] codec not supported: ' + codec);\r\n                    return false;\r\n                }\r\n                return true;\r\n            });\r\n\r\n            return as.Representation_asArray && as.Representation_asArray.length > 0;\r\n        });\r\n\r\n    }\r\n\r\n    function _filterUnsupportedEssentialProperties(streamInfo) {\r\n        const realPeriod = adapter.getRealPeriodByIndex(streamInfo ? streamInfo.index : null);\r\n\r\n        if (!realPeriod || !realPeriod.AdaptationSet_asArray || realPeriod.AdaptationSet_asArray.length === 0) {\r\n            return;\r\n        }\r\n\r\n        realPeriod.AdaptationSet_asArray = realPeriod.AdaptationSet_asArray.filter((as) => {\r\n\r\n            if (!as.Representation_asArray || as.Representation_asArray.length === 0) {\r\n                return true;\r\n            }\r\n\r\n            as.Representation_asArray = as.Representation_asArray.filter((rep) => {\r\n                const essentialProperties = adapter.getEssentialPropertiesForRepresentation(rep);\r\n\r\n                if (essentialProperties && essentialProperties.length > 0) {\r\n                    let i = 0;\r\n                    while (i < essentialProperties.length) {\r\n                        if (!capabilities.supportsEssentialProperty(essentialProperties[i])) {\r\n                            logger.debug('[Stream] EssentialProperty not supported: ' + essentialProperties[i].schemeIdUri);\r\n                            return false;\r\n                        }\r\n                        i += 1;\r\n                    }\r\n                }\r\n\r\n                return true;\r\n            });\r\n\r\n            return as.Representation_asArray && as.Representation_asArray.length > 0;\r\n        });\r\n\r\n    }\r\n\r\n    instance = {\r\n        setConfig,\r\n        filterUnsupportedFeaturesOfPeriod\r\n    };\r\n\r\n    setup();\r\n\r\n    return instance;\r\n}\r\n\r\nCapabilitiesFilter.__dashjs_factory_name = 'CapabilitiesFilter';\r\nexport default FactoryMaker.getSingletonFactory(CapabilitiesFilter);\r\n"]}