{"version":3,"sources":["../../../../../src/streaming/utils/DOMStorage.js"],"names":["legacyKeysAndReplacements","oldKey","newKey","LOCAL_STORAGE_BITRATE_KEY_TEMPLATE","LOCAL_STORAGE_SETTINGS_KEY_TEMPLATE","STORAGE_TYPE_LOCAL","STORAGE_TYPE_SESSION","LAST_BITRATE","LAST_MEDIA_SETTINGS","DOMStorage","config","context","settings","instance","logger","supported","setup","getInstance","getLogger","translateLegacyKeys","isSupported","type","undefined","testKey","testValue","storage","window","error","warn","message","setItem","removeItem","forEach","value","localStorage","getItem","entry","e","getTimestamp","ten_minutes_ms","Math","round","Date","getTime","canStore","storageType","key","get","streaming","enabled","checkConfig","Error","Constants","MISSING_CONFIG_ERROR","getSavedMediaSettings","mediaSettings","replace","obj","JSON","parse","isExpired","parseInt","timestamp","lastMediaSettingsCachingInfo","ttl","getSavedBitrateSettings","savedBitrate","NaN","lastBitrateCachingInfo","bitrate","parseFloat","isNaN","debug","setSavedMediaSettings","stringify","setSavedBitrateSettings","toFixed","__dashjs_factory_name","factory","FactoryMaker","getSingletonFactory"],"mappings":"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","file":"DOMStorage.js","sourcesContent":["/**\r\n * The copyright in this software is being made available under the BSD License,\r\n * included below. This software may be subject to other third party and contributor\r\n * rights, including patent rights, and no such rights are granted under this license.\r\n *\r\n * Copyright (c) 2013, Dash Industry Forum.\r\n * All rights reserved.\r\n *\r\n * Redistribution and use in source and binary forms, with or without modification,\r\n * are permitted provided that the following conditions are met:\r\n *  * Redistributions of source code must retain the above copyright notice, this\r\n *  list of conditions and the following disclaimer.\r\n *  * Redistributions in binary form must reproduce the above copyright notice,\r\n *  this list of conditions and the following disclaimer in the documentation and/or\r\n *  other materials provided with the distribution.\r\n *  * Neither the name of Dash Industry Forum nor the names of its\r\n *  contributors may be used to endorse or promote products derived from this software\r\n *  without specific prior written permission.\r\n *\r\n *  THIS SOFTWARE IS PROVIDED BY THE COPYRIGHT HOLDERS AND CONTRIBUTORS AS IS AND ANY\r\n *  EXPRESS OR IMPLIED WARRANTIES, INCLUDING, BUT NOT LIMITED TO, THE IMPLIED\r\n *  WARRANTIES OF MERCHANTABILITY AND FITNESS FOR A PARTICULAR PURPOSE ARE DISCLAIMED.\r\n *  IN NO EVENT SHALL THE COPYRIGHT HOLDER OR CONTRIBUTORS BE LIABLE FOR ANY DIRECT,\r\n *  INDIRECT, INCIDENTAL, SPECIAL, EXEMPLARY, OR CONSEQUENTIAL DAMAGES (INCLUDING, BUT\r\n *  NOT LIMITED TO, PROCUREMENT OF SUBSTITUTE GOODS OR SERVICES; LOSS OF USE, DATA, OR\r\n *  PROFITS; OR BUSINESS INTERRUPTION) HOWEVER CAUSED AND ON ANY THEORY OF LIABILITY,\r\n *  WHETHER IN CONTRACT, STRICT LIABILITY, OR TORT (INCLUDING NEGLIGENCE OR OTHERWISE)\r\n *  ARISING IN ANY WAY OUT OF THE USE OF THIS SOFTWARE, EVEN IF ADVISED OF THE\r\n *  POSSIBILITY OF SUCH DAMAGE.\r\n */\r\nimport FactoryMaker from '../../core/FactoryMaker';\r\nimport Debug from '../../core/Debug';\r\nimport Constants from '../constants/Constants';\r\n\r\nconst legacyKeysAndReplacements = [\r\n    { oldKey: 'dashjs_vbitrate',  newKey: 'dashjs_video_bitrate' },\r\n    { oldKey: 'dashjs_abitrate',  newKey: 'dashjs_audio_bitrate' },\r\n    { oldKey: 'dashjs_vsettings', newKey: 'dashjs_video_settings' },\r\n    { oldKey: 'dashjs_asettings', newKey: 'dashjs_audio_settings' }\r\n];\r\n\r\nconst LOCAL_STORAGE_BITRATE_KEY_TEMPLATE = 'dashjs_?_bitrate';\r\nconst LOCAL_STORAGE_SETTINGS_KEY_TEMPLATE = 'dashjs_?_settings';\r\n\r\nconst STORAGE_TYPE_LOCAL = 'localStorage';\r\nconst STORAGE_TYPE_SESSION = 'sessionStorage';\r\nconst LAST_BITRATE = 'lastBitrate';\r\nconst LAST_MEDIA_SETTINGS = 'lastMediaSettings';\r\n\r\nfunction DOMStorage(config) {\r\n\r\n    config = config || {};\r\n    const context = this.context;\r\n    const settings = config.settings;\r\n\r\n    let instance,\r\n        logger,\r\n        supported;\r\n\r\n    function setup() {\r\n        logger = Debug(context).getInstance().getLogger(instance);\r\n        translateLegacyKeys();\r\n    }\r\n\r\n    //type can be local, session\r\n    function isSupported(type) {\r\n        if (supported !== undefined) return supported;\r\n\r\n        supported = false;\r\n\r\n        const testKey = '1';\r\n        const testValue = '1';\r\n        let storage;\r\n\r\n        try {\r\n            if (typeof window !== 'undefined') {\r\n                storage = window[type];\r\n            }\r\n        } catch (error) {\r\n            logger.warn('DOMStorage access denied: ' + error.message);\r\n            return supported;\r\n        }\r\n\r\n        if (!storage || (type !== STORAGE_TYPE_LOCAL && type !== STORAGE_TYPE_SESSION)) {\r\n            return supported;\r\n        }\r\n\r\n        /* When Safari (OS X or iOS) is in private browsing mode, it appears as though localStorage is available, but trying to call setItem throws an exception.\r\n         http://stackoverflow.com/questions/14555347/html5-localstorage-error-with-safari-quota-exceeded-err-dom-exception-22-an\r\n\r\n         Check if the storage can be used\r\n         */\r\n        try {\r\n            storage.setItem(testKey, testValue);\r\n            storage.removeItem(testKey);\r\n            supported = true;\r\n        } catch (error) {\r\n            logger.warn('DOMStorage is supported, but cannot be used: ' + error.message);\r\n        }\r\n\r\n        return supported;\r\n    }\r\n\r\n    function translateLegacyKeys() {\r\n        if (isSupported(STORAGE_TYPE_LOCAL)) {\r\n            legacyKeysAndReplacements.forEach(entry => {\r\n                const value = localStorage.getItem(entry.oldKey);\r\n\r\n                if (value) {\r\n                    localStorage.removeItem(entry.oldKey);\r\n\r\n                    try {\r\n                        localStorage.setItem(entry.newKey, value);\r\n                    } catch (e) {\r\n                        logger.error(e.message);\r\n                    }\r\n                }\r\n            });\r\n        }\r\n    }\r\n\r\n    // Return current epoch time, ms, rounded to the nearest 10m to avoid fingerprinting user\r\n    function getTimestamp() {\r\n        const ten_minutes_ms = 60 * 1000 * 10;\r\n        return Math.round(new Date().getTime() / ten_minutes_ms) * ten_minutes_ms;\r\n    }\r\n\r\n    function canStore(storageType, key) {\r\n        return isSupported(storageType) && settings.get().streaming[key + 'CachingInfo'].enabled;\r\n    }\r\n\r\n    function checkConfig() {\r\n        if (!settings) {\r\n            throw new Error(Constants.MISSING_CONFIG_ERROR);\r\n        }\r\n    }\r\n\r\n    function getSavedMediaSettings(type) {\r\n        let mediaSettings = null;\r\n\r\n        checkConfig();\r\n        //Checks local storage to see if there is valid, non-expired media settings\r\n        if (canStore(STORAGE_TYPE_LOCAL, LAST_MEDIA_SETTINGS)) {\r\n            const key = LOCAL_STORAGE_SETTINGS_KEY_TEMPLATE.replace(/\\?/, type);\r\n            try {\r\n                const obj = JSON.parse(localStorage.getItem(key)) || {};\r\n                const isExpired = (new Date().getTime() - parseInt(obj.timestamp, 10)) >= settings.get().streaming.lastMediaSettingsCachingInfo.ttl || false;\r\n                mediaSettings = obj.settings;\r\n\r\n                if (isExpired) {\r\n                    localStorage.removeItem(key);\r\n                    mediaSettings = null;\r\n                }\r\n            } catch (e) {\r\n                return null;\r\n            }\r\n        }\r\n        return mediaSettings;\r\n    }\r\n\r\n    function getSavedBitrateSettings(type) {\r\n        let savedBitrate = NaN;\r\n\r\n        checkConfig();\r\n\r\n        //Checks local storage to see if there is valid, non-expired bit rate\r\n        //hinting from the last play session to use as a starting bit rate.\r\n        if (canStore(STORAGE_TYPE_LOCAL, LAST_BITRATE)) {\r\n            const key = LOCAL_STORAGE_BITRATE_KEY_TEMPLATE.replace(/\\?/, type);\r\n            try {\r\n                const obj = JSON.parse(localStorage.getItem(key)) || {};\r\n                const isExpired = (new Date().getTime() - parseInt(obj.timestamp, 10)) >= settings.get().streaming.lastBitrateCachingInfo.ttl || false;\r\n                const bitrate = parseFloat(obj.bitrate);\r\n\r\n                if (!isNaN(bitrate) && !isExpired) {\r\n                    savedBitrate = bitrate;\r\n                    logger.debug('Last saved bitrate for ' + type + ' was ' + bitrate);\r\n                } else if (isExpired) {\r\n                    localStorage.removeItem(key);\r\n                }\r\n            } catch (e) {\r\n                return null;\r\n            }\r\n        }\r\n        return savedBitrate;\r\n    }\r\n\r\n    function setSavedMediaSettings(type, value) {\r\n        if (canStore(STORAGE_TYPE_LOCAL, LAST_MEDIA_SETTINGS)) {\r\n            const key = LOCAL_STORAGE_SETTINGS_KEY_TEMPLATE.replace(/\\?/, type);\r\n            try {\r\n                localStorage.setItem(key, JSON.stringify({settings: value, timestamp: getTimestamp()}));\r\n            } catch (e) {\r\n                logger.error(e.message);\r\n            }\r\n        }\r\n    }\r\n\r\n    function setSavedBitrateSettings(type, bitrate) {\r\n        if (canStore(STORAGE_TYPE_LOCAL, LAST_BITRATE) && bitrate) {\r\n            const key = LOCAL_STORAGE_BITRATE_KEY_TEMPLATE.replace(/\\?/, type);\r\n            try {\r\n                localStorage.setItem(key, JSON.stringify({bitrate: bitrate.toFixed(3), timestamp: getTimestamp()}));\r\n            } catch (e) {\r\n                logger.error(e.message);\r\n            }\r\n        }\r\n    }\r\n\r\n    instance = {\r\n        getSavedBitrateSettings: getSavedBitrateSettings,\r\n        setSavedBitrateSettings: setSavedBitrateSettings,\r\n        getSavedMediaSettings: getSavedMediaSettings,\r\n        setSavedMediaSettings: setSavedMediaSettings\r\n    };\r\n\r\n    setup();\r\n    return instance;\r\n}\r\n\r\nDOMStorage.__dashjs_factory_name = 'DOMStorage';\r\nconst factory = FactoryMaker.getSingletonFactory(DOMStorage);\r\nexport default factory;\r\n"]}