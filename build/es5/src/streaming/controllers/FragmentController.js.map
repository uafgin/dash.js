{"version":3,"sources":["../../../../../src/streaming/controllers/FragmentController.js"],"names":["FragmentController","config","context","eventBus","getInstance","errHandler","mediaPlayerModel","dashMetrics","debug","streamInfo","instance","logger","fragmentModels","setup","getLogger","resetInitialSettings","on","Events","FRAGMENT_LOADING_COMPLETED","onFragmentLoadingCompleted","FRAGMENT_LOADING_PROGRESS","getStreamId","id","getModel","type","model","create","fragmentLoader","requestModifier","settings","boxParser","events","errors","Errors","dashConstants","urlUtils","reset","off","createDataChunk","bytes","request","streamId","endFragment","chunk","DataChunk","mediaInfo","segmentType","start","startTime","duration","end","index","quality","representationId","e","sender","response","isInit","isInitializationRequest","strInfo","error","mediaType","Constants","AUDIO","VIDEO","FRAGMENTED_TEXT","trigger","SERVICE_LOCATION_BLACKLIST_ADD","entry","serviceLocation","warn","INIT_FRAGMENT_LOADED","MEDIA_FRAGMENT_LOADED","__dashjs_factory_name","FactoryMaker","getClassFactory"],"mappings":"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","file":"FragmentController.js","sourcesContent":["/**\r\n * The copyright in this software is being made available under the BSD License,\r\n * included below. This software may be subject to other third party and contributor\r\n * rights, including patent rights, and no such rights are granted under this license.\r\n *\r\n * Copyright (c) 2013, Dash Industry Forum.\r\n * All rights reserved.\r\n *\r\n * Redistribution and use in source and binary forms, with or without modification,\r\n * are permitted provided that the following conditions are met:\r\n *  * Redistributions of source code must retain the above copyright notice, this\r\n *  list of conditions and the following disclaimer.\r\n *  * Redistributions in binary form must reproduce the above copyright notice,\r\n *  this list of conditions and the following disclaimer in the documentation and/or\r\n *  other materials provided with the distribution.\r\n *  * Neither the name of Dash Industry Forum nor the names of its\r\n *  contributors may be used to endorse or promote products derived from this software\r\n *  without specific prior written permission.\r\n *\r\n *  THIS SOFTWARE IS PROVIDED BY THE COPYRIGHT HOLDERS AND CONTRIBUTORS AS IS AND ANY\r\n *  EXPRESS OR IMPLIED WARRANTIES, INCLUDING, BUT NOT LIMITED TO, THE IMPLIED\r\n *  WARRANTIES OF MERCHANTABILITY AND FITNESS FOR A PARTICULAR PURPOSE ARE DISCLAIMED.\r\n *  IN NO EVENT SHALL THE COPYRIGHT HOLDER OR CONTRIBUTORS BE LIABLE FOR ANY DIRECT,\r\n *  INDIRECT, INCIDENTAL, SPECIAL, EXEMPLARY, OR CONSEQUENTIAL DAMAGES (INCLUDING, BUT\r\n *  NOT LIMITED TO, PROCUREMENT OF SUBSTITUTE GOODS OR SERVICES; LOSS OF USE, DATA, OR\r\n *  PROFITS; OR BUSINESS INTERRUPTION) HOWEVER CAUSED AND ON ANY THEORY OF LIABILITY,\r\n *  WHETHER IN CONTRACT, STRICT LIABILITY, OR TORT (INCLUDING NEGLIGENCE OR OTHERWISE)\r\n *  ARISING IN ANY WAY OUT OF THE USE OF THIS SOFTWARE, EVEN IF ADVISED OF THE\r\n *  POSSIBILITY OF SUCH DAMAGE.\r\n */\r\nimport Constants from '../constants/Constants';\r\nimport DataChunk from '../vo/DataChunk';\r\nimport FragmentModel from '../models/FragmentModel';\r\nimport FragmentLoader from '../FragmentLoader';\r\nimport RequestModifier from '../utils/RequestModifier';\r\nimport EventBus from '../../core/EventBus';\r\nimport Events from '../../core/events/Events';\r\nimport Errors from '../../core/errors/Errors';\r\nimport FactoryMaker from '../../core/FactoryMaker';\r\nimport Debug from '../../core/Debug';\r\n\r\nfunction FragmentController( config ) {\r\n\r\n    config = config || {};\r\n    const context = this.context;\r\n    const eventBus = EventBus(context).getInstance();\r\n\r\n    const errHandler = config.errHandler;\r\n    const mediaPlayerModel = config.mediaPlayerModel;\r\n    const dashMetrics = config.dashMetrics;\r\n    const debug = Debug(context).getInstance();\r\n    const streamInfo = config.streamInfo;\r\n\r\n    let instance,\r\n        logger,\r\n        fragmentModels;\r\n\r\n    function setup() {\r\n        logger = debug.getLogger(instance);\r\n        resetInitialSettings();\r\n        eventBus.on(Events.FRAGMENT_LOADING_COMPLETED, onFragmentLoadingCompleted, instance);\r\n        eventBus.on(Events.FRAGMENT_LOADING_PROGRESS, onFragmentLoadingCompleted, instance);\r\n    }\r\n\r\n    function getStreamId() {\r\n        return streamInfo.id;\r\n    }\r\n\r\n    function getModel(type) {\r\n        let model = fragmentModels[type];\r\n        if (!model) {\r\n            model = FragmentModel(context).create({\r\n                streamInfo: streamInfo,\r\n                type: type,\r\n                dashMetrics: dashMetrics,\r\n                fragmentLoader: FragmentLoader(context).create({\r\n                    dashMetrics: dashMetrics,\r\n                    mediaPlayerModel: mediaPlayerModel,\r\n                    errHandler: errHandler,\r\n                    requestModifier: RequestModifier(context).getInstance(),\r\n                    settings: config.settings,\r\n                    boxParser: config.boxParser,\r\n                    eventBus: eventBus,\r\n                    events: Events,\r\n                    errors: Errors,\r\n                    dashConstants: config.dashConstants,\r\n                    urlUtils: config.urlUtils\r\n                }),\r\n                debug: debug,\r\n                eventBus: eventBus,\r\n                events: Events\r\n            });\r\n\r\n            fragmentModels[type] = model;\r\n        }\r\n\r\n        return model;\r\n    }\r\n\r\n    function resetInitialSettings() {\r\n        for (let model in fragmentModels) {\r\n            fragmentModels[model].reset();\r\n        }\r\n        fragmentModels = {};\r\n    }\r\n\r\n    function reset() {\r\n        eventBus.off(Events.FRAGMENT_LOADING_COMPLETED, onFragmentLoadingCompleted, this);\r\n        eventBus.off(Events.FRAGMENT_LOADING_PROGRESS, onFragmentLoadingCompleted, this);\r\n        resetInitialSettings();\r\n    }\r\n\r\n    function createDataChunk(bytes, request, streamId, endFragment) {\r\n        const chunk = new DataChunk();\r\n\r\n        chunk.streamId = streamId;\r\n        chunk.mediaInfo = request.mediaInfo;\r\n        chunk.segmentType = request.type;\r\n        chunk.start = request.startTime;\r\n        chunk.duration = request.duration;\r\n        chunk.end = chunk.start + chunk.duration;\r\n        chunk.bytes = bytes;\r\n        chunk.index = request.index;\r\n        chunk.quality = request.quality;\r\n        chunk.representationId = request.representationId;\r\n        chunk.endFragment = endFragment;\r\n\r\n        return chunk;\r\n    }\r\n\r\n    function onFragmentLoadingCompleted(e) {\r\n        // Event propagation may have been stopped (see MssHandler)\r\n        if (!e.sender) return;\r\n\r\n        const request = e.request;\r\n        const bytes = e.response;\r\n        const isInit = request.isInitializationRequest();\r\n        const strInfo = request.mediaInfo.streamInfo;\r\n\r\n        if (e.error) {\r\n            if (request.mediaType === Constants.AUDIO || request.mediaType === Constants.VIDEO || request.mediaType === Constants.FRAGMENTED_TEXT) {\r\n                // add service location to blacklist controller - only for audio or video. text should not set errors\r\n                eventBus.trigger(Events.SERVICE_LOCATION_BLACKLIST_ADD, { entry: e.request.serviceLocation });\r\n            }\r\n        }\r\n\r\n        if (!bytes || !strInfo) {\r\n            logger.warn('No ' + request.mediaType + ' bytes to push or stream is inactive.');\r\n            return;\r\n        }\r\n        const chunk = createDataChunk(bytes, request, streamInfo.id, e.type !== Events.FRAGMENT_LOADING_PROGRESS);\r\n        eventBus.trigger(isInit ? Events.INIT_FRAGMENT_LOADED : Events.MEDIA_FRAGMENT_LOADED,\r\n            {\r\n                chunk: chunk,\r\n                request: request\r\n            },\r\n            { streamId: strInfo.id, mediaType: request.mediaType }\r\n        );\r\n    }\r\n\r\n    instance = {\r\n        getStreamId: getStreamId,\r\n        getModel: getModel,\r\n        reset: reset\r\n    };\r\n\r\n    setup();\r\n\r\n    return instance;\r\n}\r\n\r\nFragmentController.__dashjs_factory_name = 'FragmentController';\r\nexport default FactoryMaker.getClassFactory(FragmentController);\r\n"]}