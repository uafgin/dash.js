{"version":3,"sources":["../../../../../src/streaming/text/TextController.js"],"names":["TextController","context","instance","textSourceBuffer","errHandler","adapter","manifestModel","mediaController","videoModel","streamController","textTracks","vttParser","ttmlParser","eventBus","defaultSettings","initialSettingsSet","lastEnabledIndex","textDefaultEnabled","allTracksAreDisabled","forceTextStreaming","textTracksAdded","disableTextBeforeTextTracksAdded","previousPeriodSelectedTrack","setup","getInstance","initialize","on","Events","TEXT_TRACKS_QUEUE_INITIALIZED","onTextTracksAdded","CURRENT_TRACK_CHANGED","onCurrentTrackChanged","PERIOD_SWITCH_STARTED","onPeriodSwitchStarted","STREAM_COMPLETED","onStreamCompleted","PERIOD_SWITCH_COMPLETED","onPeriodSwitchCompleted","resetInitialSettings","e","undefined","fromStreamInfo","getCurrentTrackIdx","setTextTrack","setConfig","config","getTextSourceBuffer","getAllTracksAreDisabled","addEmbeddedTrack","mediaInfo","setTextDefaultLanguage","lang","setInitialSettings","settings","getTextDefaultLanguage","tracks","index","some","item","idx","matchSettings","trigger","TEXT_TRACKS_ADDED","enabled","isTextEnabled","event","newMediaInfo","type","Constants","FRAGMENTED_TEXT","role","roles","accessibility","setTextDefaultEnabled","enable","getTextDefaultEnabled","enableText","enableForcedTextStreaming","getConfig","fragmentModel","fragmentedTracks","mediaInfosArr","streamProcessor","oldTrackIdx","saveTextSettingsDisabled","setModeForTrackIdx","TEXT_HIDDEN","setCurrentTrackIdx","TEXT_SHOWING","currentTrackInfo","getCurrentTrackInfo","isFragmented","isEmbedded","i","length","id","currentFragTrack","getCurrentTrackFor","getActiveStreamInfo","abortRequests","removeExecutedRequestsBeforeTime","remove","deleteCuesFromTrackIdx","setTrack","setCurrentFragmentedTrackIdx","streamProcessors","getActiveStreamProcessors","getType","setBufferingTime","getTime","getScheduleController","start","TEXT","getMediaInfoArr","selectMediaInfo","reset","resetEmbedded","__dashjs_factory_name","FactoryMaker","getSingletonFactory"],"mappings":"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","file":"TextController.js","sourcesContent":["/**\r\n * The copyright in this software is being made available under the BSD License,\r\n * included below. This software may be subject to other third party and contributor\r\n * rights, including patent rights, and no such rights are granted under this license.\r\n *\r\n * Copyright (c) 2013, Dash Industry Forum.\r\n * All rights reserved.\r\n *\r\n * Redistribution and use in source and binary forms, with or without modification,\r\n * are permitted provided that the following conditions are met:\r\n *  * Redistributions of source code must retain the above copyright notice, this\r\n *  list of conditions and the following disclaimer.\r\n *  * Redistributions in binary form must reproduce the above copyright notice,\r\n *  this list of conditions and the following disclaimer in the documentation and/or\r\n *  other materials provided with the distribution.\r\n *  * Neither the name of Dash Industry Forum nor the names of its\r\n *  contributors may be used to endorse or promote products derived from this software\r\n *  without specific prior written permission.\r\n *\r\n *  THIS SOFTWARE IS PROVIDED BY THE COPYRIGHT HOLDERS AND CONTRIBUTORS AS IS AND ANY\r\n *  EXPRESS OR IMPLIED WARRANTIES, INCLUDING, BUT NOT LIMITED TO, THE IMPLIED\r\n *  WARRANTIES OF MERCHANTABILITY AND FITNESS FOR A PARTICULAR PURPOSE ARE DISCLAIMED.\r\n *  IN NO EVENT SHALL THE COPYRIGHT HOLDER OR CONTRIBUTORS BE LIABLE FOR ANY DIRECT,\r\n *  INDIRECT, INCIDENTAL, SPECIAL, EXEMPLARY, OR CONSEQUENTIAL DAMAGES (INCLUDING, BUT\r\n *  NOT LIMITED TO, PROCUREMENT OF SUBSTITUTE GOODS OR SERVICES; LOSS OF USE, DATA, OR\r\n *  PROFITS; OR BUSINESS INTERRUPTION) HOWEVER CAUSED AND ON ANY THEORY OF LIABILITY,\r\n *  WHETHER IN CONTRACT, STRICT LIABILITY, OR TORT (INCLUDING NEGLIGENCE OR OTHERWISE)\r\n *  ARISING IN ANY WAY OUT OF THE USE OF THIS SOFTWARE, EVEN IF ADVISED OF THE\r\n *  POSSIBILITY OF SUCH DAMAGE.\r\n */\r\nimport Constants from '../constants/Constants';\r\nimport FactoryMaker from '../../core/FactoryMaker';\r\nimport TextSourceBuffer from './TextSourceBuffer';\r\nimport TextTracks from './TextTracks';\r\nimport VTTParser from '../utils/VTTParser';\r\nimport TTMLParser from '../utils/TTMLParser';\r\nimport EventBus from '../../core/EventBus';\r\nimport Events from '../../core/events/Events';\r\nimport { checkParameterType } from '../utils/SupervisorTools';\r\n\r\nfunction TextController() {\r\n\r\n    let context = this.context;\r\n\r\n    let instance,\r\n        textSourceBuffer,\r\n        errHandler,\r\n        adapter,\r\n        manifestModel,\r\n        mediaController,\r\n        videoModel,\r\n        streamController,\r\n        textTracks,\r\n        vttParser,\r\n        ttmlParser,\r\n        eventBus,\r\n        defaultSettings,\r\n        initialSettingsSet,\r\n        lastEnabledIndex,\r\n        textDefaultEnabled, // this is used for default settings (each time a file is loaded, we check value of this settings )\r\n        allTracksAreDisabled, // this is used for one session (when a file has been loaded, we use this settings to enable/disable text)\r\n        forceTextStreaming,\r\n        textTracksAdded,\r\n        disableTextBeforeTextTracksAdded,\r\n        previousPeriodSelectedTrack;\r\n\r\n    function setup() {\r\n\r\n        defaultSettings = null;\r\n        lastEnabledIndex = -1;\r\n        forceTextStreaming = false;\r\n        textTracksAdded = false;\r\n        initialSettingsSet = false;\r\n        disableTextBeforeTextTracksAdded = false;\r\n        textTracks = TextTracks(context).getInstance();\r\n        vttParser = VTTParser(context).getInstance();\r\n        ttmlParser = TTMLParser(context).getInstance();\r\n        textSourceBuffer = TextSourceBuffer(context).getInstance();\r\n        eventBus = EventBus(context).getInstance();\r\n\r\n        textTracks.initialize();\r\n        eventBus.on(Events.TEXT_TRACKS_QUEUE_INITIALIZED, onTextTracksAdded, instance);\r\n        eventBus.on(Events.CURRENT_TRACK_CHANGED, onCurrentTrackChanged, instance);\r\n\r\n        /*\r\n        * register those event callbacks in order to detect switch of periods and set\r\n        * correctly the selected track index in the new period.\r\n        * there is different cases :\r\n        *   - switch occurs after a seek command from the user\r\n        *   - switch occurs but codecs in streams are different\r\n        *   - switch occurs and codecs in streams are not different\r\n        */\r\n        eventBus.on(Events.PERIOD_SWITCH_STARTED, onPeriodSwitchStarted, instance);\r\n        eventBus.on(Events.STREAM_COMPLETED, onStreamCompleted, instance);\r\n        eventBus.on(Events.PERIOD_SWITCH_COMPLETED, onPeriodSwitchCompleted, instance);\r\n\r\n        resetInitialSettings();\r\n    }\r\n\r\n    function onPeriodSwitchStarted(e) {\r\n        if (previousPeriodSelectedTrack === undefined && e.fromStreamInfo !== null /* test if this is the first period */) {\r\n            previousPeriodSelectedTrack = this.getCurrentTrackIdx();\r\n        }\r\n    }\r\n\r\n    function onStreamCompleted() {\r\n        if (previousPeriodSelectedTrack === undefined) {\r\n            previousPeriodSelectedTrack = this.getCurrentTrackIdx();\r\n        }\r\n    }\r\n\r\n    function onPeriodSwitchCompleted() {\r\n        if (previousPeriodSelectedTrack !== undefined) {\r\n            this.setTextTrack(previousPeriodSelectedTrack);\r\n            previousPeriodSelectedTrack = undefined;\r\n        }\r\n    }\r\n\r\n    function setConfig(config) {\r\n        if (!config) {\r\n            return;\r\n        }\r\n        if (config.errHandler) {\r\n            errHandler = config.errHandler;\r\n        }\r\n        if (config.adapter) {\r\n            adapter = config.adapter;\r\n        }\r\n        if (config.manifestModel) {\r\n            manifestModel = config.manifestModel;\r\n        }\r\n        if (config.mediaController) {\r\n            mediaController = config.mediaController;\r\n        }\r\n        if (config.videoModel) {\r\n            videoModel = config.videoModel;\r\n        }\r\n        if (config.streamController) {\r\n            streamController = config.streamController;\r\n        }\r\n        if (config.textTracks) {\r\n            textTracks = config.textTracks;\r\n        }\r\n        if (config.vttParser) {\r\n            vttParser = config.vttParser;\r\n        }\r\n        if (config.ttmlParser) {\r\n            ttmlParser = config.ttmlParser;\r\n        }\r\n\r\n        // create config for source buffer\r\n        textSourceBuffer.setConfig({\r\n            errHandler: errHandler,\r\n            adapter: adapter,\r\n            manifestModel: manifestModel,\r\n            mediaController: mediaController,\r\n            videoModel: videoModel,\r\n            streamController: streamController,\r\n            textTracks: textTracks,\r\n            vttParser: vttParser,\r\n            ttmlParser: ttmlParser\r\n        });\r\n    }\r\n\r\n    function getTextSourceBuffer() {\r\n        return textSourceBuffer;\r\n    }\r\n\r\n    function getAllTracksAreDisabled() {\r\n        return allTracksAreDisabled;\r\n    }\r\n\r\n    function addEmbeddedTrack(mediaInfo) {\r\n        textSourceBuffer.addEmbeddedTrack(mediaInfo);\r\n    }\r\n\r\n    function setTextDefaultLanguage(lang) {\r\n        checkParameterType(lang, 'string');\r\n        if (!defaultSettings) {\r\n            defaultSettings = {};\r\n        }\r\n        defaultSettings.lang = lang;\r\n        initialSettingsSet = true;\r\n    }\r\n\r\n    function setInitialSettings(settings) {\r\n        defaultSettings = settings;\r\n        initialSettingsSet = true;\r\n    }\r\n\r\n    function getTextDefaultLanguage() {\r\n        return defaultSettings && defaultSettings.lang || '';\r\n    }\r\n\r\n    function onTextTracksAdded(e) {\r\n        let tracks = e.tracks;\r\n        let index = e.index;\r\n\r\n        if (defaultSettings) {\r\n            tracks.some((item, idx) => {\r\n                // matchSettings is compatible with setTextDefaultLanguage and setInitialSettings\r\n                if (mediaController.matchSettings(defaultSettings, item)) {\r\n                    this.setTextTrack(idx);\r\n                    index = idx;\r\n                    return true;\r\n                }\r\n            });\r\n        }\r\n\r\n        if (textDefaultEnabled === false || ( textDefaultEnabled === undefined && !defaultSettings ) || disableTextBeforeTextTracksAdded) {\r\n            // disable text at startup if explicitely configured with setTextDefaultEnabled(false) or if there is no defaultSettings (configuration or from domStorage)\r\n            this.setTextTrack(-1);\r\n        }\r\n\r\n        lastEnabledIndex = index;\r\n        eventBus.trigger(Events.TEXT_TRACKS_ADDED, {\r\n            enabled: isTextEnabled(),\r\n            index: index,\r\n            tracks: tracks\r\n        });\r\n        textTracksAdded = true;\r\n    }\r\n\r\n    function onCurrentTrackChanged(event) {\r\n        if (!initialSettingsSet && event && event.newMediaInfo) {\r\n            let mediaInfo = event.newMediaInfo;\r\n            if (mediaInfo.type === Constants.FRAGMENTED_TEXT) {\r\n                defaultSettings = {\r\n                    lang: mediaInfo.lang,\r\n                    role: mediaInfo.roles[0],\r\n                    accessibility: mediaInfo.accessibility[0]\r\n                };\r\n            }\r\n        }\r\n    }\r\n\r\n    function setTextDefaultEnabled(enable) {\r\n        checkParameterType(enable,'boolean');\r\n        textDefaultEnabled = enable;\r\n\r\n        if (!textDefaultEnabled) {\r\n            // disable text at startup\r\n            this.setTextTrack(-1);\r\n        } else {\r\n            allTracksAreDisabled = false;\r\n        }\r\n    }\r\n\r\n    function getTextDefaultEnabled() {\r\n        return textDefaultEnabled === undefined ? false : textDefaultEnabled;\r\n    }\r\n\r\n    function enableText(enable) {\r\n        checkParameterType(enable,'boolean');\r\n        if (!textDefaultEnabled && enable) {\r\n            textDefaultEnabled = true;\r\n        }\r\n        if (isTextEnabled() !== enable) {\r\n            // change track selection\r\n            if (enable) {\r\n                // apply last enabled track\r\n                this.setTextTrack(lastEnabledIndex);\r\n            }\r\n\r\n            if (!enable) {\r\n                // keep last index and disable text track\r\n                lastEnabledIndex = this.getCurrentTrackIdx();\r\n                if (!textTracksAdded) {\r\n                    disableTextBeforeTextTracksAdded = true;\r\n                } else {\r\n                    this.setTextTrack(-1);\r\n                }\r\n            }\r\n        }\r\n    }\r\n\r\n    function isTextEnabled() {\r\n        let enabled = true;\r\n        if (allTracksAreDisabled && !forceTextStreaming) {\r\n            enabled = false;\r\n        }\r\n        return enabled;\r\n    }\r\n\r\n    // when set to true ScheduleController will allow schedule of chunks even if tracks are all disabled. Allowing streaming to hidden track for external players to work with.\r\n    function enableForcedTextStreaming(enable) {\r\n        checkParameterType(enable,'boolean');\r\n        forceTextStreaming = enable;\r\n    }\r\n\r\n    function setTextTrack(idx) {\r\n        //For external time text file, the only action needed to change a track is marking the track mode to showing.\r\n        // Fragmented text tracks need the additional step of calling TextController.setTextTrack();\r\n        let config = textSourceBuffer.getConfig();\r\n        let fragmentModel = config.fragmentModel;\r\n        let fragmentedTracks = config.fragmentedTracks;\r\n        let videoModel = config.videoModel;\r\n        let mediaInfosArr,\r\n            streamProcessor;\r\n\r\n        allTracksAreDisabled = idx === -1 ? true : false;\r\n\r\n        let oldTrackIdx = textTracks.getCurrentTrackIdx();\r\n        if (oldTrackIdx !== idx) {\r\n            if (allTracksAreDisabled && mediaController) {\r\n                mediaController.saveTextSettingsDisabled();\r\n            }\r\n            textTracks.setModeForTrackIdx(oldTrackIdx, Constants.TEXT_HIDDEN);\r\n            textTracks.setCurrentTrackIdx(idx);\r\n            textTracks.setModeForTrackIdx(idx, Constants.TEXT_SHOWING);\r\n\r\n            let currentTrackInfo = textTracks.getCurrentTrackInfo();\r\n\r\n            if (currentTrackInfo && currentTrackInfo.isFragmented && !currentTrackInfo.isEmbedded) {\r\n                for (let i = 0; i < fragmentedTracks.length; i++) {\r\n                    let mediaInfo = fragmentedTracks[i];\r\n                    if (currentTrackInfo.lang === mediaInfo.lang && currentTrackInfo.index === mediaInfo.index &&\r\n                        (mediaInfo.id ? currentTrackInfo.id === mediaInfo.id : currentTrackInfo.id === mediaInfo.index)) {\r\n                        let currentFragTrack = mediaController.getCurrentTrackFor(Constants.FRAGMENTED_TEXT, streamController.getActiveStreamInfo());\r\n                        if (mediaInfo !== currentFragTrack) {\r\n                            fragmentModel.abortRequests();\r\n                            fragmentModel.removeExecutedRequestsBeforeTime();\r\n                            textSourceBuffer.remove();\r\n                            textTracks.deleteCuesFromTrackIdx(oldTrackIdx);\r\n                            mediaController.setTrack(mediaInfo);\r\n                            textSourceBuffer.setCurrentFragmentedTrackIdx(i);\r\n                        } else if (oldTrackIdx === -1) {\r\n                            //in fragmented use case, if the user selects the older track (the one selected before disabled text track)\r\n                            //no CURRENT_TRACK_CHANGED event will be trigger, so dashHandler current time has to be updated and the scheduleController\r\n                            //has to be restarted.\r\n                            const streamProcessors = streamController.getActiveStreamProcessors();\r\n                            for (let i = 0; i < streamProcessors.length; i++) {\r\n                                if (streamProcessors[i].getType() === Constants.FRAGMENTED_TEXT) {\r\n                                    streamProcessor = streamProcessors[i];\r\n                                    break;\r\n                                }\r\n                            }\r\n                            streamProcessor.setBufferingTime(videoModel.getTime());\r\n                            streamProcessor.getScheduleController().start();\r\n                        }\r\n                    }\r\n                }\r\n            } else if (currentTrackInfo && !currentTrackInfo.isFragmented) {\r\n                const streamProcessors = streamController.getActiveStreamProcessors();\r\n                for (let i = 0; i < streamProcessors.length; i++) {\r\n                    if (streamProcessors[i].getType() === Constants.TEXT) {\r\n                        streamProcessor = streamProcessors[i];\r\n                        mediaInfosArr = streamProcessor.getMediaInfoArr();\r\n                        break;\r\n                    }\r\n                }\r\n\r\n                if (streamProcessor && mediaInfosArr) {\r\n                    for (let i = 0; i < mediaInfosArr.length; i++) {\r\n                        if (mediaInfosArr[i].index === currentTrackInfo.index && mediaInfosArr[i].lang === currentTrackInfo.lang) {\r\n                            streamProcessor.selectMediaInfo(mediaInfosArr[i]);\r\n                            break;\r\n                        }\r\n                    }\r\n                }\r\n            }\r\n        }\r\n    }\r\n\r\n    function getCurrentTrackIdx() {\r\n        return textTracks.getCurrentTrackIdx();\r\n    }\r\n\r\n    function resetInitialSettings() {\r\n        allTracksAreDisabled = true;\r\n        textTracksAdded = false;\r\n        disableTextBeforeTextTracksAdded = false;\r\n    }\r\n\r\n    function reset() {\r\n        resetInitialSettings();\r\n        textSourceBuffer.resetEmbedded();\r\n        textSourceBuffer.reset();\r\n    }\r\n\r\n    instance = {\r\n        setConfig: setConfig,\r\n        getTextSourceBuffer: getTextSourceBuffer,\r\n        getAllTracksAreDisabled: getAllTracksAreDisabled,\r\n        addEmbeddedTrack: addEmbeddedTrack,\r\n        getTextDefaultLanguage: getTextDefaultLanguage,\r\n        setTextDefaultLanguage: setTextDefaultLanguage,\r\n        setTextDefaultEnabled: setTextDefaultEnabled,\r\n        getTextDefaultEnabled: getTextDefaultEnabled,\r\n        setInitialSettings: setInitialSettings,\r\n        enableText: enableText,\r\n        isTextEnabled: isTextEnabled,\r\n        setTextTrack: setTextTrack,\r\n        getCurrentTrackIdx: getCurrentTrackIdx,\r\n        enableForcedTextStreaming: enableForcedTextStreaming,\r\n        reset: reset\r\n    };\r\n    setup();\r\n    return instance;\r\n}\r\n\r\nTextController.__dashjs_factory_name = 'TextController';\r\nexport default FactoryMaker.getSingletonFactory(TextController);\r\n"]}