{"version":3,"sources":["../../../../src/dash/WebmSegmentBaseLoader.js"],"names":["WebmSegmentBaseLoader","context","instance","logger","WebM","errHandler","requestModifier","dashMetrics","mediaPlayerModel","urlLoader","settings","eventBus","events","errors","baseURLController","setup","EBML","tag","required","Segment","SeekHead","Info","TimecodeScale","parse","Duration","Tracks","Cues","CuePoint","CueTime","CueTrackPositions","CueTrack","CueClusterPosition","Void","initialize","create","useFetch","get","streaming","lowLatencyEnabled","setConfig","config","Error","Constants","MISSING_CONFIG_ERROR","debug","getLogger","parseCues","ab","cues","ebmlParser","data","cue","cueTrack","consumeTagAndSize","moreData","parseTag","CueTracks","consumeTag","cueTrackPositionSize","getMatroskaCodedNum","startPos","getPos","Track","ClusterPosition","push","setPos","length","parseSegments","segmentStart","segmentEnd","segmentDuration","duration","parsed","segments","segment","i","len","start","end","startTime","timescale","mediaRange","parseEbmlHeader","media","theRange","callback","byteLength","parts","split","request","info","url","range","parseFloat","skipOverElement","undefined","infoTag","infoElementSize","getFragmentRequest","onload","response","onloadend","error","load","success","checkConfig","hasOwnProperty","loadInitialization","streamId","mediaType","representation","loadingInfo","baseUrl","resolve","path","initRange","init","trigger","INITIALIZATION_LOADED","loadSegments","bytesToLoad","bytesLoaded","onLoaded","SEGMENTS_LOADED","DashJSError","SEGMENT_BASE_LOADER_ERROR_CODE","SEGMENT_BASE_LOADER_ERROR_MESSAGE","FragmentRequest","setInfo","reset","__dashjs_factory_name","FactoryMaker","getSingletonFactory"],"mappings":"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","file":"WebmSegmentBaseLoader.js","sourcesContent":["import EBMLParser from '../streaming/utils/EBMLParser';\r\nimport Constants from '../streaming/constants/Constants';\r\nimport FactoryMaker from '../core/FactoryMaker';\r\nimport Segment from './vo/Segment';\r\nimport FragmentRequest from '../streaming/vo/FragmentRequest';\r\nimport URLLoader from '../streaming/net/URLLoader';\r\nimport DashJSError from '../streaming/vo/DashJSError';\r\n\r\nfunction WebmSegmentBaseLoader() {\r\n\r\n    const context = this.context;\r\n\r\n    let instance,\r\n        logger,\r\n        WebM,\r\n        errHandler,\r\n        requestModifier,\r\n        dashMetrics,\r\n        mediaPlayerModel,\r\n        urlLoader,\r\n        settings,\r\n        eventBus,\r\n        events,\r\n        errors,\r\n        baseURLController;\r\n\r\n    function setup() {\r\n        WebM = {\r\n            EBML: {\r\n                tag: 0x1A45DFA3,\r\n                required: true\r\n            },\r\n            Segment: {\r\n                tag: 0x18538067,\r\n                required: true,\r\n                SeekHead: {\r\n                    tag: 0x114D9B74,\r\n                    required: true\r\n                },\r\n                Info: {\r\n                    tag: 0x1549A966,\r\n                    required: true,\r\n                    TimecodeScale: {\r\n                        tag: 0x2AD7B1,\r\n                        required: true,\r\n                        parse: 'getMatroskaUint'\r\n                    },\r\n                    Duration: {\r\n                        tag: 0x4489,\r\n                        required: true,\r\n                        parse: 'getMatroskaFloat'\r\n                    }\r\n                },\r\n                Tracks: {\r\n                    tag: 0x1654AE6B,\r\n                    required: true\r\n                },\r\n                Cues: {\r\n                    tag: 0x1C53BB6B,\r\n                    required: true,\r\n                    CuePoint: {\r\n                        tag: 0xBB,\r\n                        required: true,\r\n                        CueTime: {\r\n                            tag: 0xB3,\r\n                            required: true,\r\n                            parse: 'getMatroskaUint'\r\n                        },\r\n                        CueTrackPositions: {\r\n                            tag: 0xB7,\r\n                            required: true,\r\n                            CueTrack: {\r\n                                tag: 0xF7,\r\n                                required: true,\r\n                                parse: 'getMatroskaUint'\r\n                            },\r\n                            CueClusterPosition: {\r\n                                tag: 0xF1,\r\n                                required: true,\r\n                                parse: 'getMatroskaUint'\r\n                            }\r\n                        }\r\n                    }\r\n                }\r\n            },\r\n            Void: {\r\n                tag: 0xEC,\r\n                required: true\r\n            }\r\n        };\r\n    }\r\n\r\n    function initialize() {\r\n        urlLoader = URLLoader(context).create({\r\n            errHandler: errHandler,\r\n            dashMetrics: dashMetrics,\r\n            mediaPlayerModel: mediaPlayerModel,\r\n            requestModifier: requestModifier,\r\n            useFetch: settings ? settings.get().streaming.lowLatencyEnabled : null,\r\n            errors: errors\r\n        });\r\n    }\r\n\r\n    function setConfig(config) {\r\n        if (!config.baseURLController || !config.dashMetrics || !config.mediaPlayerModel || !config.errHandler) {\r\n            throw new Error(Constants.MISSING_CONFIG_ERROR);\r\n        }\r\n        baseURLController = config.baseURLController;\r\n        dashMetrics = config.dashMetrics;\r\n        mediaPlayerModel = config.mediaPlayerModel;\r\n        errHandler = config.errHandler;\r\n        settings = config.settings;\r\n        events = config.events;\r\n        eventBus = config.eventBus;\r\n        errors = config.errors;\r\n        logger = config.debug.getLogger(instance);\r\n        requestModifier = config.requestModifier;\r\n    }\r\n\r\n    function parseCues(ab) {\r\n        let cues = [];\r\n        let ebmlParser = EBMLParser(context).create({\r\n            data: ab\r\n        });\r\n        let cue,\r\n            cueTrack;\r\n\r\n        ebmlParser.consumeTagAndSize(WebM.Segment.Cues);\r\n\r\n        while (ebmlParser.moreData() &&\r\n            ebmlParser.consumeTagAndSize(WebM.Segment.Cues.CuePoint, true)) {\r\n            cue = {};\r\n\r\n            cue.CueTime = ebmlParser.parseTag(WebM.Segment.Cues.CuePoint.CueTime);\r\n\r\n            cue.CueTracks = [];\r\n            while (ebmlParser.moreData() &&\r\n                ebmlParser.consumeTag(WebM.Segment.Cues.CuePoint.CueTrackPositions, true)) {\r\n                const cueTrackPositionSize = ebmlParser.getMatroskaCodedNum();\r\n                const startPos = ebmlParser.getPos();\r\n                cueTrack = {};\r\n\r\n                cueTrack.Track = ebmlParser.parseTag(WebM.Segment.Cues.CuePoint.CueTrackPositions.CueTrack);\r\n                if (cueTrack.Track === 0) {\r\n                    throw new Error('Cue track cannot be 0');\r\n                }\r\n\r\n                cueTrack.ClusterPosition =\r\n                    ebmlParser.parseTag(WebM.Segment.Cues.CuePoint.CueTrackPositions.CueClusterPosition);\r\n\r\n                cue.CueTracks.push(cueTrack);\r\n\r\n                // we're not interested any other elements - skip remaining bytes\r\n                ebmlParser.setPos(startPos + cueTrackPositionSize);\r\n            }\r\n\r\n            if (cue.CueTracks.length === 0) {\r\n                throw new Error('Mandatory cuetrack not found');\r\n            }\r\n            cues.push(cue);\r\n        }\r\n\r\n        if (cues.length === 0) {\r\n            throw new Error('mandatory cuepoint not found');\r\n        }\r\n        return cues;\r\n    }\r\n\r\n    function parseSegments(data, segmentStart, segmentEnd, segmentDuration) {\r\n        let duration,\r\n            parsed,\r\n            segments,\r\n            segment,\r\n            i,\r\n            len,\r\n            start,\r\n            end;\r\n\r\n        parsed = parseCues(data);\r\n        segments = [];\r\n\r\n        // we are assuming one cue track per cue point\r\n        // both duration and media range require the i + 1 segment\r\n        // the final segment has to use global segment parameters\r\n        for (i = 0, len = parsed.length; i < len; i += 1) {\r\n            segment = new Segment();\r\n            duration = 0;\r\n\r\n            if (i < parsed.length - 1) {\r\n                duration = parsed[i + 1].CueTime - parsed[i].CueTime;\r\n            } else {\r\n                duration = segmentDuration - parsed[i].CueTime;\r\n            }\r\n\r\n            // note that we don't explicitly set segment.media as this will be\r\n            // computed when all BaseURLs are resolved later\r\n            segment.duration = duration;\r\n            segment.startTime = parsed[i].CueTime;\r\n            segment.timescale = 1000; // hardcoded for ms\r\n            start = parsed[i].CueTracks[0].ClusterPosition + segmentStart;\r\n\r\n            if (i < parsed.length - 1) {\r\n                end = parsed[i + 1].CueTracks[0].ClusterPosition + segmentStart - 1;\r\n            } else {\r\n                end = segmentEnd - 1;\r\n            }\r\n\r\n            segment.mediaRange = start + '-' + end;\r\n            segments.push(segment);\r\n        }\r\n\r\n        logger.debug('Parsed cues: ' + segments.length + ' cues.');\r\n\r\n        return segments;\r\n    }\r\n\r\n    function parseEbmlHeader(data, media, theRange, callback) {\r\n        if (!data || data.byteLength === 0) {\r\n            callback(null);\r\n            return;\r\n        }\r\n        let ebmlParser = EBMLParser(context).create({\r\n            data: data\r\n        });\r\n        let duration,\r\n            segments,\r\n            segmentEnd,\r\n            segmentStart;\r\n        let parts = theRange ? theRange.split('-') : null;\r\n        let request = null;\r\n        let info = {\r\n            url: media,\r\n            range: {\r\n                start: parts ? parseFloat(parts[0]) : null,\r\n                end: parts ? parseFloat(parts[1]) : null\r\n            },\r\n            request: request\r\n        };\r\n\r\n        logger.debug('Parse EBML header: ' + info.url);\r\n\r\n        // skip over the header itself\r\n        ebmlParser.skipOverElement(WebM.EBML);\r\n        ebmlParser.consumeTag(WebM.Segment);\r\n\r\n        // segments start here\r\n        segmentEnd = ebmlParser.getMatroskaCodedNum();\r\n        segmentEnd += ebmlParser.getPos();\r\n        segmentStart = ebmlParser.getPos();\r\n\r\n        // skip over any top level elements to get to the segment info\r\n        while (ebmlParser.moreData() &&\r\n            !ebmlParser.consumeTagAndSize(WebM.Segment.Info, true)) {\r\n            if (!(ebmlParser.skipOverElement(WebM.Segment.SeekHead, true) ||\r\n                    ebmlParser.skipOverElement(WebM.Segment.Tracks, true) ||\r\n                    ebmlParser.skipOverElement(WebM.Segment.Cues, true) ||\r\n                    ebmlParser.skipOverElement(WebM.Void, true))) {\r\n                throw new Error('no valid top level element found');\r\n            }\r\n        }\r\n\r\n        // we only need one thing in segment info, duration\r\n        while (duration === undefined) {\r\n            let infoTag = ebmlParser.getMatroskaCodedNum(true);\r\n            let infoElementSize = ebmlParser.getMatroskaCodedNum();\r\n\r\n            switch (infoTag) {\r\n                case WebM.Segment.Info.Duration.tag:\r\n                    duration = ebmlParser[WebM.Segment.Info.Duration.parse](infoElementSize);\r\n                    break;\r\n                default:\r\n                    ebmlParser.setPos(ebmlParser.getPos() + infoElementSize);\r\n                    break;\r\n            }\r\n        }\r\n\r\n        // once we have what we need from segment info, we jump right to the\r\n        // cues\r\n\r\n        request = getFragmentRequest(info);\r\n\r\n        const onload = function (response) {\r\n            segments = parseSegments(response, segmentStart, segmentEnd, duration);\r\n            callback(segments);\r\n        };\r\n\r\n        const onloadend = function () {\r\n            logger.error('Download Error: Cues ' + info.url);\r\n            callback(null);\r\n        };\r\n\r\n        urlLoader.load({\r\n            request: request,\r\n            success: onload,\r\n            error: onloadend\r\n        });\r\n\r\n        logger.debug('Perform cues load: ' + info.url + ' bytes=' + info.range.start + '-' + info.range.end);\r\n    }\r\n\r\n    function checkConfig() {\r\n        if (!baseURLController || !baseURLController.hasOwnProperty('resolve')) {\r\n            throw new Error('setConfig function has to be called previously');\r\n        }\r\n    }\r\n\r\n    function loadInitialization(streamId, mediaType, representation, loadingInfo) {\r\n        checkConfig();\r\n        let request = null;\r\n        let baseUrl = representation ? baseURLController.resolve(representation.path) : null;\r\n        let initRange = representation ? representation.range.split('-') : null;\r\n        let info = loadingInfo || {\r\n            range: {\r\n                start: initRange ? parseFloat(initRange[0]) : null,\r\n                end: initRange ? parseFloat(initRange[1]) : null\r\n            },\r\n            request: request,\r\n            url: baseUrl ? baseUrl.url : undefined,\r\n            init: true,\r\n            mediaType: mediaType\r\n        };\r\n\r\n        logger.info('Start loading initialization.');\r\n\r\n        request = getFragmentRequest(info);\r\n\r\n        const onload = function () {\r\n            // note that we don't explicitly set rep.initialization as this\r\n            // will be computed when all BaseURLs are resolved later\r\n            eventBus.trigger(events.INITIALIZATION_LOADED,\r\n                { representation: representation },\r\n                { streamId: streamId, mediaType: mediaType }\r\n            );\r\n        };\r\n\r\n        const onloadend = function () {\r\n            eventBus.trigger(events.INITIALIZATION_LOADED,\r\n                { representation: representation },\r\n                { streamId: streamId, mediaType: mediaType }\r\n            );\r\n        };\r\n\r\n        urlLoader.load({\r\n            request: request,\r\n            success: onload,\r\n            error: onloadend\r\n        });\r\n\r\n        logger.debug('Perform init load: ' + info.url);\r\n    }\r\n\r\n    function loadSegments(streamId, mediaType, representation, theRange, callback) {\r\n        checkConfig();\r\n        let request = null;\r\n        let baseUrl = representation ? baseURLController.resolve(representation.path) : null;\r\n        let media = baseUrl ? baseUrl.url : undefined;\r\n        let bytesToLoad = 8192;\r\n        let info = {\r\n            bytesLoaded: 0,\r\n            bytesToLoad: bytesToLoad,\r\n            range: {\r\n                start: 0,\r\n                end: bytesToLoad\r\n            },\r\n            request: request,\r\n            url: media,\r\n            init: false,\r\n            mediaType: mediaType\r\n        };\r\n\r\n        callback = !callback ? onLoaded : callback;\r\n        request = getFragmentRequest(info);\r\n\r\n        // first load the header, but preserve the manifest range so we can\r\n        // load the cues after parsing the header\r\n        // NOTE: we expect segment info to appear in the first 8192 bytes\r\n        logger.debug('Parsing ebml header');\r\n\r\n        const onload = function (response) {\r\n            parseEbmlHeader(response, media, theRange, function (segments) {\r\n                callback(streamId, mediaType, segments, representation);\r\n            });\r\n        };\r\n\r\n        const onloadend = function () {\r\n            callback(streamId, mediaType, null, representation);\r\n        };\r\n\r\n        urlLoader.load({\r\n            request: request,\r\n            success: onload,\r\n            error: onloadend\r\n        });\r\n    }\r\n\r\n    function onLoaded(streamId, mediaType, segments, representation) {\r\n        eventBus.trigger(events.SEGMENTS_LOADED,\r\n            {\r\n                segments: segments,\r\n                representation: representation,\r\n                error: segments ? undefined : new DashJSError(errors.SEGMENT_BASE_LOADER_ERROR_CODE, errors.SEGMENT_BASE_LOADER_ERROR_MESSAGE)\r\n            },\r\n            { streamId: streamId, mediaType: mediaType }\r\n        );\r\n    }\r\n\r\n    function getFragmentRequest(info) {\r\n        const request = new FragmentRequest();\r\n        request.setInfo(info);\r\n        return request;\r\n    }\r\n\r\n    function reset() {\r\n        errHandler = null;\r\n        requestModifier = null;\r\n    }\r\n\r\n    instance = {\r\n        setConfig: setConfig,\r\n        initialize: initialize,\r\n        loadInitialization: loadInitialization,\r\n        loadSegments: loadSegments,\r\n        reset: reset\r\n    };\r\n\r\n    setup();\r\n\r\n    return instance;\r\n}\r\n\r\nWebmSegmentBaseLoader.__dashjs_factory_name = 'WebmSegmentBaseLoader';\r\nexport default FactoryMaker.getSingletonFactory(WebmSegmentBaseLoader);\r\n"]}