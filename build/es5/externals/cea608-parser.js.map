{"version":3,"sources":["../../../externals/cea608-parser.js"],"names":["exports","specialCea608CharsCodes","getCharForByte","byte","charCode","hasOwnProperty","String","fromCharCode","NR_ROWS","NR_COLS","rowsLowCh1","rowsHighCh1","rowsLowCh2","rowsHighCh2","backgroundColors","logger","verboseFilter","time","verboseLevel","setTime","newTime","log","severity","msg","minLevel","console","numArrayToHexArray","numArray","hexArray","j","length","push","toString","PenState","foreground","underline","italics","background","flash","prototype","reset","setStyles","styles","attribs","i","style","isDefault","equals","other","copy","newPenState","StyledUnicodeChar","uchar","penState","setChar","setPenState","newChar","isEmpty","Row","chars","pos","currPenState","equal","empty","setCursor","absPos","moveCursor","relPos","newPos","backSpace","insertChar","char","clearFromPos","startPos","clear","clearToEndOfRow","getTextString","join","setPenStyles","currChar","CaptionScreen","rows","currRow","nrRollUpRows","row","setPen","setPAC","pacData","JSON","stringify","newRow","indent","prevPos","Math","max","color","setBkgData","bkgData","setRollUpRows","nrRows","rollUp","getDisplayText","topRowIndex","topRow","splice","asOneRow","displayText","text","rowNr","rowText","trim","getTextAndFormat","Cea608Channel","channelNumber","outputFilter","chNr","mode","verbose","displayedMemory","nonDisplayedMemory","lastOutputScreen","currRollUpRow","writeScreen","cueStartTime","modes","lastCueEndTime","getHandler","setHandler","newHandler","setMode","newMode","insertChars","screen","outputDataUpdate","cc_RCL","cc_BS","cc_AOF","cc_AON","cc_DER","cc_RU","cc_FON","cc_RDC","cc_TR","cc_RTD","cc_EDM","cc_CR","cc_ENM","cc_EOC","tmp","cc_TO","nrCols","cc_MIDROW","secondByte","colorIndex","floor","colors","t","updateData","newCue","cueSplitAtTime","Cea608Parser","field","out1","out2","outputs","channels","currChNr","lastCmdA","lastCmdB","bufferedData","startTime","lastTime","dataCounters","index","addData","byteList","cmdFound","a","b","charsFound","padding","parseCmd","parseMidrow","parsePAC","parseBackgroundAttributes","parseChars","channel","cmd","cond1","cond2","case1","case2","interpretPAC","pacIndex","channelNr","charCodes","charCode1","charCode2","oneCode","hexCodes","findCea608Nalus","raw","size","nalSize","cursor","nalType","cea608NaluRanges","isCEA608SEI","payloadType","payloadSize","countryCode","getUint8","providerCode","getUint16","userIdentifier","getUint32","userDataTypeCode","extractCea608DataFromRange","cea608Range","fieldData","ccCount","ccValid","ccType","ccData1","ccData2","cea608parser"],"mappings":"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","file":"cea608-parser.js","sourcesContent":["/**\r\n * The copyright in this software is being made available under the BSD License,\r\n * included below. This software may be subject to other third party and contributor\r\n * rights, including patent rights, and no such rights are granted under this license.\r\n *\r\n * Copyright (c) 2015-2016, DASH Industry Forum.\r\n * All rights reserved.\r\n *\r\n * Redistribution and use in source and binary forms, with or without modification,\r\n * are permitted provided that the following conditions are met:\r\n *  1. Redistributions of source code must retain the above copyright notice, this\r\n *  list of conditions and the following disclaimer.\r\n *  * Redistributions in binary form must reproduce the above copyright notice,\r\n *  this list of conditions and the following disclaimer in the documentation and/or\r\n *  other materials provided with the distribution.\r\n *  2. Neither the name of Dash Industry Forum nor the names of its\r\n *  contributors may be used to endorse or promote products derived from this software\r\n *  without specific prior written permission.\r\n *\r\n *  THIS SOFTWARE IS PROVIDED BY THE COPYRIGHT HOLDERS AND CONTRIBUTORS AS IS AND ANY\r\n *  EXPRESS OR IMPLIED WARRANTIES, INCLUDING, BUT NOT LIMITED TO, THE IMPLIED\r\n *  WARRANTIES OF MERCHANTABILITY AND FITNESS FOR A PARTICULAR PURPOSE ARE DISCLAIMED.\r\n *  IN NO EVENT SHALL THE COPYRIGHT HOLDER OR CONTRIBUTORS BE LIABLE FOR ANY DIRECT,\r\n *  INDIRECT, INCIDENTAL, SPECIAL, EXEMPLARY, OR CONSEQUENTIAL DAMAGES (INCLUDING, BUT\r\n *  NOT LIMITED TO, PROCUREMENT OF SUBSTITUTE GOODS OR SERVICES; LOSS OF USE, DATA, OR\r\n *  PROFITS; OR BUSINESS INTERRUPTION) HOWEVER CAUSED AND ON ANY THEORY OF LIABILITY,\r\n *  WHETHER IN CONTRACT, STRICT LIABILITY, OR TORT (INCLUDING NEGLIGENCE OR OTHERWISE)\r\n *  ARISING IN ANY WAY OUT OF THE USE OF THIS SOFTWARE, EVEN IF ADVISED OF THE\r\n *  POSSIBILITY OF SUCH DAMAGE.\r\n */\r\n(function(exports) {\r\n\r\n    \"use strict\";\r\n\r\n    /**\r\n     *  Exceptions from regular ASCII. CodePoints are mapped to UTF-16 codes\r\n     */\r\n\r\n    var specialCea608CharsCodes = {\r\n        0x2a : 0xe1, // lowercase a, acute accent\r\n        0x5c : 0xe9, // lowercase e, acute accent\r\n        0x5e : 0xed, // lowercase i, acute accent\r\n        0x5f : 0xf3, // lowercase o, acute accent\r\n        0x60 : 0xfa, // lowercase u, acute accent\r\n        0x7b : 0xe7, // lowercase c with cedilla\r\n        0x7c : 0xf7, // division symbol\r\n        0x7d : 0xd1, // uppercase N tilde\r\n        0x7e : 0xf1, // lowercase n tilde\r\n        0x7f : 0x2588, // Full block\r\n        // THIS BLOCK INCLUDES THE 16 EXTENDED (TWO-BYTE) LINE 21 CHARACTERS\r\n        // THAT COME FROM HI BYTE=0x11 AND LOW BETWEEN 0x30 AND 0x3F\r\n        // THIS MEANS THAT \\x50 MUST BE ADDED TO THE VALUES\r\n        0x80 : 0xae, // Registered symbol (R)\r\n        0x81 : 0xb0, // degree sign\r\n        0x82 : 0xbd, // 1/2 symbol\r\n        0x83 : 0xbf, // Inverted (open) question mark\r\n        0x84 : 0x2122, // Trademark symbol (TM)\r\n        0x85 : 0xa2, // Cents symbol\r\n        0x86 : 0xa3, // Pounds sterling\r\n        0x87 : 0x266a, // Music 8'th note\r\n        0x88 : 0xe0, // lowercase a, grave accent\r\n        0x89 : 0x20, // transparent space (regular)\r\n        0x8a : 0xe8, // lowercase e, grave accent\r\n        0x8b : 0xe2, // lowercase a, circumflex accent\r\n        0x8c : 0xea, // lowercase e, circumflex accent\r\n        0x8d : 0xee, // lowercase i, circumflex accent\r\n        0x8e : 0xf4, // lowercase o, circumflex accent\r\n        0x8f : 0xfb, // lowercase u, circumflex accent\r\n        // THIS BLOCK INCLUDES THE 32 EXTENDED (TWO-BYTE) LINE 21 CHARACTERS\r\n        // THAT COME FROM HI BYTE=0x12 AND LOW BETWEEN 0x20 AND 0x3F\r\n        0x90 : 0xc1, // capital letter A with acute\r\n        0x91 : 0xc9, // capital letter E with acute\r\n        0x92 : 0xd3, // capital letter O with acute\r\n        0x93 : 0xda, // capital letter U with acute\r\n        0x94 : 0xdc, // capital letter U with diaresis\r\n        0x95 : 0xfc, // lowercase letter U with diaeresis\r\n        0x96 : 0x2018, // opening single quote\r\n        0x97 : 0xa1, // inverted exclamation mark\r\n        0x98 : 0x2a, // asterisk\r\n        0x99 : 0x2019, // closing single quote\r\n        0x9a : 0x2501, // box drawings heavy horizontal\r\n        0x9b : 0xa9, // copyright sign\r\n        0x9c : 0x2120, // Service mark\r\n        0x9d : 0x2022, // (round) bullet\r\n        0x9e : 0x201c, // Left double quotation mark\r\n        0x9f : 0x201d, // Right double quotation mark\r\n        0xa0 : 0xc0, // uppercase A, grave accent\r\n        0xa1 : 0xc2, // uppercase A, circumflex\r\n        0xa2 : 0xc7, // uppercase C with cedilla\r\n        0xa3 : 0xc8, // uppercase E, grave accent\r\n        0xa4 : 0xca, // uppercase E, circumflex\r\n        0xa5 : 0xcb, // capital letter E with diaresis\r\n        0xa6 : 0xeb, // lowercase letter e with diaresis\r\n        0xa7 : 0xce, // uppercase I, circumflex\r\n        0xa8 : 0xcf, // uppercase I, with diaresis\r\n        0xa9 : 0xef, // lowercase i, with diaresis\r\n        0xaa : 0xd4, // uppercase O, circumflex\r\n        0xab : 0xd9, // uppercase U, grave accent\r\n        0xac : 0xf9, // lowercase u, grave accent\r\n        0xad : 0xdb, // uppercase U, circumflex\r\n        0xae : 0xab, // left-pointing double angle quotation mark\r\n        0xaf : 0xbb, // right-pointing double angle quotation mark\r\n        // THIS BLOCK INCLUDES THE 32 EXTENDED (TWO-BYTE) LINE 21 CHARACTERS\r\n        // THAT COME FROM HI BYTE=0x13 AND LOW BETWEEN 0x20 AND 0x3F\r\n        0xb0 : 0xc3, // Uppercase A, tilde\r\n        0xb1 : 0xe3, // Lowercase a, tilde\r\n        0xb2 : 0xcd, // Uppercase I, acute accent\r\n        0xb3 : 0xcc, // Uppercase I, grave accent\r\n        0xb4 : 0xec, // Lowercase i, grave accent\r\n        0xb5 : 0xd2, // Uppercase O, grave accent\r\n        0xb6 : 0xf2, // Lowercase o, grave accent\r\n        0xb7 : 0xd5, // Uppercase O, tilde\r\n        0xb8 : 0xf5, // Lowercase o, tilde\r\n        0xb9 : 0x7b, // Open curly brace\r\n        0xba : 0x7d, // Closing curly brace\r\n        0xbb : 0x5c, // Backslash\r\n        0xbc : 0x5e, // Caret\r\n        0xbd : 0x5f, // Underscore\r\n        0xbe : 0x7c, // Pipe (vertical line)\r\n        0xbf : 0x223c, // Tilde operator\r\n        0xc0 : 0xc4, // Uppercase A, umlaut\r\n        0xc1 : 0xe4, // Lowercase A, umlaut\r\n        0xc2 : 0xd6, // Uppercase O, umlaut\r\n        0xc3 : 0xf6, // Lowercase o, umlaut\r\n        0xc4 : 0xdf, // Esszett (sharp S)\r\n        0xc5 : 0xa5, // Yen symbol\r\n        0xc6 : 0xa4, // Generic currency sign\r\n        0xc7 : 0x2503, // Box drawings heavy vertical\r\n        0xc8 : 0xc5, // Uppercase A, ring\r\n        0xc9 : 0xe5, // Lowercase A, ring\r\n        0xca : 0xd8, // Uppercase O, stroke\r\n        0xcb : 0xf8, // Lowercase o, strok\r\n        0xcc : 0x250f, // Box drawings heavy down and right\r\n        0xcd : 0x2513, // Box drawings heavy down and left\r\n        0xce : 0x2517, // Box drawings heavy up and right\r\n        0xcf : 0x251b // Box drawings heavy up and left\r\n    };\r\n\r\n    /**\r\n     * Get Unicode Character from CEA-608 byte code\r\n     */\r\n    var getCharForByte = function(byte) {\r\n        var charCode = byte;\r\n        if (specialCea608CharsCodes.hasOwnProperty(byte)) {\r\n            charCode = specialCea608CharsCodes[byte];\r\n        }\r\n        return String.fromCharCode(charCode);\r\n    };\r\n\r\n    var NR_ROWS = 15,\r\n        NR_COLS = 32;\r\n    // Tables to look up row from PAC data\r\n    var rowsLowCh1 = {0x11 : 1, 0x12 : 3, 0x15 : 5, 0x16 : 7, 0x17 : 9, 0x10 : 11, 0x13 : 12, 0x14 : 14};\r\n    var rowsHighCh1 = {0x11 : 2, 0x12 : 4, 0x15 : 6, 0x16 : 8, 0x17 : 10, 0x13 : 13, 0x14 : 15};\r\n    var rowsLowCh2 = {0x19 : 1, 0x1A : 3, 0x1D : 5, 0x1E : 7, 0x1F : 9, 0x18 : 11, 0x1B : 12, 0x1C : 14};\r\n    var rowsHighCh2 = {0x19 : 2, 0x1A : 4, 0x1D : 6, 0x1E : 8, 0x1F : 10, 0x1B : 13, 0x1C : 15};\r\n\r\n    var backgroundColors = ['white', 'green', 'blue', 'cyan', 'red', 'yellow', 'magenta', 'black', 'transparent'];\r\n\r\n    /**\r\n     * Simple logger class to be able to write with time-stamps and filter on level.\r\n     */\r\n    var logger = {\r\n        verboseFilter : {'DATA' : 3, 'DEBUG' : 3, 'INFO' : 2, 'WARNING' : 2, 'TEXT' : 1, 'ERROR' : 0},\r\n        time : null,\r\n        verboseLevel : 0, // Only write errors\r\n        setTime : function(newTime) {\r\n            this.time = newTime;\r\n        },\r\n        log : function(severity, msg) {\r\n            var minLevel = this.verboseFilter[severity];\r\n            if (this.verboseLevel >= minLevel) {\r\n                console.log(this.time + \" [\" + severity + \"] \" + msg);\r\n            }\r\n        }\r\n    };\r\n\r\n    var numArrayToHexArray = function(numArray) {\r\n        var hexArray = [];\r\n        for (var j = 0; j < numArray.length; j++) {\r\n            hexArray.push(numArray[j].toString(16));\r\n        }\r\n        return hexArray;\r\n    };\r\n\r\n    /**\r\n     * State of CEA-608 pen or character\r\n     * @constructor\r\n     */\r\n    var PenState = function(foreground, underline, italics, background, flash) {\r\n        this.foreground = foreground || \"white\";\r\n        this.underline = underline || false;\r\n        this.italics = italics || false;\r\n        this.background = background || \"black\";\r\n        this.flash = flash || false;\r\n    };\r\n\r\n    PenState.prototype = {\r\n        \r\n        reset : function() {\r\n            this.foreground = \"white\";\r\n            this.underline = false;\r\n            this.italics = false;\r\n            this.background = \"black\";\r\n            this.flash = false;\r\n        },\r\n        \r\n        setStyles : function(styles) {\r\n            var attribs = [\"foreground\", \"underline\", \"italics\", \"background\", \"flash\"];\r\n            for (var i = 0 ; i < attribs.length; i++) {\r\n                var style = attribs[i];\r\n                if (styles.hasOwnProperty(style)) {\r\n                    this[style] = styles[style];\r\n                }\r\n            }\r\n        },\r\n        \r\n        isDefault : function() {\r\n            return (this.foreground === \"white\" && !this.underline && !this.italics && \r\n                    this.background === \"black\" && !this.flash);\r\n        },\r\n\r\n        equals : function(other) {\r\n            return ( (this.foreground === other.foreground) && \r\n                     (this.underline === other.underline) &&\r\n                     (this.italics === other.italics) &&\r\n                     (this.background === other.background) &&\r\n                     (this.flash === other.flash) );\r\n        },\r\n\r\n        copy : function(newPenState) {\r\n            this.foreground = newPenState.foreground;\r\n            this.underline = newPenState.underline;\r\n            this.italics = newPenState.italics;\r\n            this.background = newPenState.background;\r\n            this.flash = newPenState.flash;\r\n        },\r\n        \r\n        toString: function() {\r\n            return (\"color=\" + this.foreground + \", underline=\" + this.underline + \", italics=\" + this.italics +\r\n                \", background=\" + this.background + \", flash=\" + this.flash);\r\n        }\r\n    };\r\n\r\n    /**\r\n     * Unicode character with styling and background.\r\n     * @constructor\r\n     */\r\n    var StyledUnicodeChar = function(uchar, foreground, underline, italics, background, flash) {\r\n        this.uchar = uchar || ' '; // unicode character\r\n        this.penState = new PenState(foreground, underline,italics, background, flash);\r\n    };\r\n\r\n    StyledUnicodeChar.prototype = {\r\n        \r\n        reset: function() {\r\n            this.uchar = ' ';\r\n            this.penState.reset();\r\n        },\r\n        \r\n        setChar: function(uchar, newPenState) {\r\n            this.uchar = uchar;\r\n            this.penState.copy(newPenState);\r\n        },\r\n        \r\n        setPenState: function(newPenState) {\r\n            this.penState.copy(newPenState);\r\n        },\r\n        \r\n        equals: function(other) {\r\n            return this.uchar === other.uchar && this.penState.equals(other.penState);\r\n        },\r\n        \r\n        copy: function(newChar) {\r\n            this.uchar = newChar.uchar;\r\n            this.penState.copy(newChar.penState);\r\n        },\r\n        \r\n        isEmpty : function() {\r\n            return this.uchar === ' ' && this.penState.isDefault();\r\n        }\r\n    };\r\n\r\n    /**\r\n     * CEA-608 row consisting of NR_COLS instances of StyledUnicodeChar.\r\n     * @constructor\r\n     */\r\n    var Row = function() {\r\n        this.chars = [];\r\n        for (var i = 0 ; i < NR_COLS ; i++) {\r\n            this.chars.push(new StyledUnicodeChar());\r\n        }\r\n        this.pos = 0;\r\n        this.currPenState = new PenState();\r\n    };\r\n\r\n    Row.prototype = {\r\n        \r\n        equals: function(other) {\r\n            var equal = true;\r\n            for (var i = 0 ; i < NR_COLS; i ++) {\r\n                if (!this.chars[i].equals(other.chars[i])) {\r\n                    equal = false;\r\n                    break;\r\n                }\r\n            }\r\n            return equal;\r\n        },\r\n        \r\n        copy: function(other) {\r\n            for (var i = 0 ; i < NR_COLS; i ++) {\r\n                this.chars[i].copy(other.chars[i]);\r\n            }\r\n        },\r\n        \r\n        isEmpty : function() {\r\n            var empty = true;\r\n            for (var i = 0 ; i < NR_COLS; i ++) {\r\n                if (!this.chars[i].isEmpty()) {\r\n                    empty = false;\r\n                    break;\r\n                }\r\n            }\r\n            return empty;\r\n        },\r\n\r\n        /**\r\n         *  Set the cursor to a valid column.\r\n         */\r\n        setCursor : function(absPos) {\r\n            if (this.pos !== absPos) {\r\n                this.pos = absPos;\r\n            }\r\n            if (this.pos < 0) {\r\n                logger.log(\"ERROR\", \"Negative cursor position \" + this.pos);\r\n                this.pos = 0;\r\n            } else if (this.pos > NR_COLS) {\r\n                logger.log(\"ERROR\", \"Too large cursor position \" + this.pos);\r\n                this.pos = NR_COLS;\r\n            }\r\n        },\r\n\r\n        /** \r\n         * Move the cursor relative to current position.\r\n         */\r\n        moveCursor : function(relPos) {\r\n            var newPos = this.pos + relPos;\r\n            if (relPos > 1) {\r\n                for (var i = this.pos+1; i < newPos+1 ; i++) {\r\n                    this.chars[i].setPenState(this.currPenState);\r\n                }\r\n            }\r\n            this.setCursor(newPos);\r\n        },\r\n\r\n        /**\r\n         * Backspace, move one step back and clear character.\r\n         */\r\n        backSpace : function () {\r\n            this.moveCursor(-1);\r\n            this.chars[this.pos].setChar(' ', this.currPenState);\r\n        },\r\n\r\n        insertChar: function(byte) {\r\n            if (byte >= 0x90) { //Extended char\r\n                this.backSpace();\r\n            }\r\n            var char = getCharForByte(byte);\r\n            if (this.pos >= NR_COLS) {\r\n                logger.log(\"ERROR\", \"Cannot insert \" + byte.toString(16) +  \r\n                            \" (\" + char + \") at position \" + this.pos + \". Skipping it!\");\r\n                return;\r\n            }\r\n            this.chars[this.pos].setChar(char, this.currPenState);\r\n            this.moveCursor(1);\r\n        },\r\n\r\n        clearFromPos : function(startPos) {\r\n            var i;\r\n            for (i = startPos ; i < NR_COLS ; i++) {\r\n                this.chars[i].reset();\r\n            }\r\n        },\r\n\r\n        clear : function() {\r\n            this.clearFromPos(0);\r\n            this.pos = 0;\r\n            this.currPenState.reset();\r\n        },\r\n\r\n        clearToEndOfRow : function() {\r\n            this.clearFromPos(this.pos);\r\n        },\r\n\r\n        getTextString: function() {\r\n            var chars = [];\r\n            var empty = true;\r\n            for (var i = 0 ; i < NR_COLS ; i++) {\r\n                var char = this.chars[i].uchar;\r\n                if (char !== \" \") {\r\n                    empty = false;\r\n                }\r\n                chars.push(char);\r\n            }\r\n            if (empty) {\r\n                return \"\";\r\n            } else {\r\n                return chars.join(\"\");\r\n            }\r\n        },\r\n\r\n        setPenStyles: function(styles) {\r\n            this.currPenState.setStyles(styles);\r\n            var currChar = this.chars[this.pos];\r\n            currChar.setPenState(this.currPenState);\r\n        }\r\n    };\r\n\r\n    /**\r\n     * Keep a CEA-608 screen of 32x15 styled characters\r\n     * @constructor\r\n    */\r\n    var CaptionScreen = function() {\r\n\r\n        this.rows = [];\r\n        for (var i = 0 ; i <  NR_ROWS; i++) {\r\n            this.rows.push(new Row()); // Note that we use zero-based numbering (0-14)\r\n        }\r\n        this.currRow = NR_ROWS - 1;\r\n        this.nrRollUpRows = null;\r\n        this.reset();\r\n    };\r\n\r\n    CaptionScreen.prototype = {\r\n\r\n        reset : function() {\r\n            for (var i = 0 ; i < NR_ROWS ; i++) {\r\n                this.rows[i].clear();\r\n            }\r\n            this.currRow = NR_ROWS - 1;\r\n        },\r\n\r\n        equals : function(other) {\r\n            var equal = true;\r\n            for (var i = 0 ; i < NR_ROWS ; i++) {\r\n                if (!this.rows[i].equals(other.rows[i])) {\r\n                    equal = false;\r\n                    break;\r\n                }\r\n            }\r\n            return equal;\r\n        },\r\n\r\n        copy : function(other) {\r\n            for (var i = 0 ; i < NR_ROWS ; i++) {\r\n                this.rows[i].copy(other.rows[i]);\r\n            }\r\n        },\r\n\r\n        isEmpty : function() {\r\n            var empty = true;\r\n            for (var i = 0 ; i < NR_ROWS ; i++) {\r\n                if (!this.rows[i].isEmpty()) {\r\n                    empty = false;\r\n                    break;\r\n                }\r\n            }\r\n            return empty;\r\n        },\r\n\r\n        backSpace : function() {\r\n            var row = this.rows[this.currRow]; \r\n            row.backSpace();\r\n        },\r\n\r\n        clearToEndOfRow : function() {\r\n            var row = this.rows[this.currRow];\r\n            row.clearToEndOfRow();\r\n        },\r\n\r\n        /**\r\n         * Insert a character (without styling) in the current row.\r\n         */\r\n        insertChar : function(char) {\r\n            var row = this.rows[this.currRow];\r\n            row.insertChar(char);\r\n        },\r\n\r\n        setPen : function(styles) {\r\n            var row = this.rows[this.currRow];\r\n            row.setPenStyles(styles);\r\n        },\r\n\r\n        moveCursor : function(relPos) {\r\n            var row = this.rows[this.currRow];\r\n            row.moveCursor(relPos); \r\n        },\r\n\r\n        setCursor : function(absPos) {\r\n            logger.log(\"INFO\", \"setCursor: \" + absPos);\r\n            var row = this.rows[this.currRow];\r\n            row.setCursor(absPos);\r\n        },\r\n\r\n        setPAC : function(pacData) {\r\n            logger.log(\"INFO\", \"pacData = \" + JSON.stringify(pacData));\r\n            var newRow = pacData.row - 1;\r\n            if (this.nrRollUpRows  && newRow < this.nrRollUpRows - 1) {\r\n                    newRow = this.nrRollUpRows-1;\r\n            }\r\n            this.currRow = newRow;\r\n            var row = this.rows[this.currRow];\r\n            if (pacData.indent !== null) {\r\n                var indent = pacData.indent;\r\n                var prevPos = Math.max(indent-1, 0);\r\n                row.setCursor(pacData.indent);\r\n                pacData.color = row.chars[prevPos].penState.foreground;\r\n            }\r\n            var styles = {foreground : pacData.color, underline : pacData.underline, italics : pacData.italics, background : 'black', flash : false};\r\n            this.setPen(styles);\r\n        },\r\n\r\n        /**\r\n         * Set background/extra foreground, but first do back_space, and then insert space (backwards compatibility).\r\n         */\r\n        setBkgData : function(bkgData) {\r\n\r\n            logger.log(\"INFO\", \"bkgData = \" + JSON.stringify(bkgData));\r\n            this.backSpace();\r\n            this.setPen(bkgData);\r\n            this.insertChar(0x20); //Space\r\n        },\r\n\r\n        setRollUpRows : function(nrRows) {\r\n            this.nrRollUpRows = nrRows;\r\n        },\r\n\r\n        rollUp : function() {\r\n            if (this.nrRollUpRows === null) {\r\n                logger.log(\"DEBUG\", \"roll_up but nrRollUpRows not set yet\");\r\n                return; //Not properly setup\r\n            }\r\n            logger.log(\"TEXT\", this.getDisplayText());\r\n            var topRowIndex = this.currRow + 1 - this.nrRollUpRows;\r\n            var topRow = this.rows.splice(topRowIndex, 1)[0];\r\n            topRow.clear();\r\n            this.rows.splice(this.currRow, 0, topRow);\r\n            logger.log(\"INFO\", \"Rolling up\");\r\n            //logger.log(\"TEXT\", this.get_display_text())\r\n        },\r\n\r\n       /**\r\n        * Get all non-empty rows with as unicode text. \r\n        */        \r\n        getDisplayText : function(asOneRow) {\r\n            asOneRow = asOneRow || false;\r\n            var displayText = [];\r\n            var text = \"\";\r\n            var rowNr = -1;\r\n            for (var i = 0 ; i < NR_ROWS ; i++) {\r\n                var rowText = this.rows[i].getTextString();\r\n                if (rowText) {\r\n                    rowNr = i+1;\r\n                    if (asOneRow) {\r\n                        displayText.push(\"Row \" + rowNr + ': \"' + rowText + '\"');\r\n                    } else {\r\n                        displayText.push(rowText.trim());\r\n                    }\r\n                }\r\n            }\r\n            if (displayText.length > 0) {\r\n                if (asOneRow) {\r\n                    text = \"[\" + displayText.join(\" | \") + \"]\";\r\n                } else {\r\n                    text = displayText.join(\"\\n\");\r\n                }\r\n            }\r\n            return text;\r\n        },\r\n\r\n        getTextAndFormat : function() {\r\n            return this.rows;\r\n        }\r\n    };\r\n\r\n    /**\r\n     * Handle a CEA-608 channel and send decoded data to outputFilter\r\n     * @constructor\r\n     * @param {Number} channelNumber (1 or 2)\r\n     * @param {CueHandler} outputFilter Output from channel1 newCue(startTime, endTime, captionScreen)\r\n    */\r\n    var Cea608Channel = function(channelNumber, outputFilter) {\r\n\r\n        this.chNr = channelNumber;\r\n        this.outputFilter = outputFilter;\r\n        this.mode = null;\r\n        this.verbose = 0;\r\n        this.displayedMemory = new CaptionScreen();\r\n        this.nonDisplayedMemory = new CaptionScreen();\r\n        this.lastOutputScreen = new CaptionScreen();\r\n        this.currRollUpRow = this.displayedMemory.rows[NR_ROWS-1];\r\n        this.writeScreen = this.displayedMemory;\r\n        this.mode = null;\r\n        this.cueStartTime = null; // Keeps track of where a cue started.\r\n    };\r\n\r\n    Cea608Channel.prototype = {\r\n        \r\n        modes : [\"MODE_ROLL-UP\", \"MODE_POP-ON\", \"MODE_PAINT-ON\", \"MODE_TEXT\"],\r\n        \r\n        reset : function() {\r\n            this.mode = null;\r\n            this.displayedMemory.reset();\r\n            this.nonDisplayedMemory.reset();\r\n            this.lastOutputScreen.reset();\r\n            this.currRollUpRow = this.displayedMemory.rows[NR_ROWS-1];\r\n            this.writeScreen = this.displayedMemory;\r\n            this.mode = null;\r\n            this.cueStartTime = null;\r\n            this.lastCueEndTime = null;\r\n        },\r\n\r\n        getHandler : function() {\r\n            return this.outputFilter;\r\n        },\r\n\r\n        setHandler : function(newHandler) {\r\n            this.outputFilter = newHandler;\r\n        },\r\n\r\n        setPAC : function(pacData) {\r\n            this.writeScreen.setPAC(pacData);\r\n        },\r\n\r\n        setBkgData : function(bkgData) {\r\n            this.writeScreen.setBkgData(bkgData);\r\n        },\r\n\r\n        setMode : function(newMode) {\r\n            if (newMode === this.mode) {\r\n                return;\r\n            }\r\n            this.mode = newMode;\r\n            logger.log(\"INFO\", \"MODE=\" + newMode);\r\n            if (this.mode == \"MODE_POP-ON\") {\r\n                this.writeScreen = this.nonDisplayedMemory;\r\n            } else {\r\n                this.writeScreen = this.displayedMemory;\r\n                this.writeScreen.reset();\r\n            }\r\n            if (this.mode !== \"MODE_ROLL-UP\") {\r\n                this.displayedMemory.nrRollUpRows = null;\r\n                this.nonDisplayedMemory.nrRollUpRows = null;\r\n            }\r\n            this.mode = newMode;\r\n        },\r\n\r\n        insertChars : function(chars) {\r\n            for (var i = 0 ; i < chars.length ; i++) {\r\n                this.writeScreen.insertChar(chars[i]);\r\n            }\r\n            var screen = this.writeScreen === this.displayedMemory ? \"DISP\" : \"NON_DISP\";\r\n            logger.log(\"INFO\", screen + \": \" + this.writeScreen.getDisplayText(true));\r\n            if (this.mode === \"MODE_PAINT-ON\" || this.mode === \"MODE_ROLL-UP\") {\r\n                logger.log(\"TEXT\", \"DISPLAYED: \" + this.displayedMemory.getDisplayText(true));\r\n                this.outputDataUpdate();\r\n            }\r\n        },\r\n\r\n        cc_RCL: function() { // Resume Caption Loading (switch mode to Pop On)\r\n            logger.log(\"INFO\", \"RCL - Resume Caption Loading\");\r\n            this.setMode(\"MODE_POP-ON\");\r\n        },\r\n        cc_BS: function() { // BackSpace\r\n            logger.log(\"INFO\", \"BS - BackSpace\");\r\n            if (this.mode === \"MODE_TEXT\") {\r\n                return;\r\n            }\r\n            this.writeScreen.backSpace();\r\n            if (this.writeScreen === this.displayedMemory) {\r\n                this.outputDataUpdate();\r\n            }\r\n        },\r\n        cc_AOF : function() { // Reserved (formerly Alarm Off)\r\n            return;\r\n        },\r\n        cc_AON: function() { // Reserved (formerly Alarm On)\r\n            return;\r\n        },\r\n        cc_DER: function() { // Delete to End of Row\r\n            logger.log(\"INFO\", \"DER- Delete to End of Row\");\r\n            this.writeScreen.clearToEndOfRow();\r\n            this.outputDataUpdate();\r\n        },\r\n        cc_RU: function(nrRows) { //Roll-Up Captions-2,3,or 4 Rows\r\n            logger.log(\"INFO\", \"RU(\" + nrRows +\") - Roll Up\");\r\n            this.writeScreen = this.displayedMemory;\r\n            this.setMode(\"MODE_ROLL-UP\");\r\n            this.writeScreen.setRollUpRows(nrRows);\r\n        },\r\n        cc_FON: function() { //Flash On\r\n            logger.log(\"INFO\", \"FON - Flash On\");\r\n            this.writeScreen.setPen({flash : true});\r\n        },\r\n        cc_RDC: function() { // Resume Direct Captioning (switch mode to PaintOn)\r\n            logger.log(\"INFO\", \"RDC - Resume Direct Captioning\");\r\n            this.setMode(\"MODE_PAINT-ON\");\r\n        },\r\n        cc_TR: function() { // Text Restart in text mode (not supported, however)\r\n            logger.log(\"INFO\", \"TR\");\r\n            this.setMode(\"MODE_TEXT\");\r\n        },\r\n        cc_RTD: function() { // Resume Text Display in Text mode (not supported, however)\r\n            logger.log(\"INFO\", \"RTD\");\r\n            this.setMode(\"MODE_TEXT\");\r\n        },\r\n        cc_EDM: function() { // Erase Displayed Memory\r\n            logger.log(\"INFO\", \"EDM - Erase Displayed Memory\");\r\n            this.displayedMemory.reset();\r\n            this.outputDataUpdate();\r\n        },\r\n        cc_CR: function() { // Carriage Return\r\n            logger.log(\"CR - Carriage Return\");\r\n            this.writeScreen.rollUp();\r\n            this.outputDataUpdate();\r\n        },\r\n        cc_ENM: function() { //Erase Non-Displayed Memory\r\n            logger.log(\"INFO\", \"ENM - Erase Non-displayed Memory\");\r\n            this.nonDisplayedMemory.reset();\r\n        },\r\n        cc_EOC: function() { //End of Caption (Flip Memories)\r\n            logger.log(\"INFO\", \"EOC - End Of Caption\");\r\n            if (this.mode === \"MODE_POP-ON\") {\r\n                var tmp = this.displayedMemory;\r\n                this.displayedMemory = this.nonDisplayedMemory;\r\n                this.nonDisplayedMemory = tmp;\r\n                this.writeScreen = this.nonDisplayedMemory;\r\n                logger.log(\"TEXT\", \"DISP: \" + this.displayedMemory.getDisplayText());\r\n            }\r\n            this.outputDataUpdate();\r\n        },\r\n        cc_TO: function(nrCols) { // Tab Offset 1,2, or 3 columns\r\n            logger.log(\"INFO\", \"TO(\" + nrCols + \") - Tab Offset\");\r\n            this.writeScreen.moveCursor(nrCols);\r\n        },\r\n        cc_MIDROW: function(secondByte) { // Parse MIDROW command\r\n            var styles = {flash : false};\r\n            styles.underline = secondByte % 2 === 1;\r\n            styles.italics = secondByte >= 0x2e;\r\n            if (!styles.italics) {\r\n                var colorIndex = Math.floor(secondByte/2) - 0x10;\r\n                var colors = [\"white\", \"green\", \"blue\", \"cyan\", \"red\", \"yellow\", \"magenta\"];\r\n                styles.foreground = colors[colorIndex];\r\n            } else {\r\n                styles.foreground = \"white\";\r\n            }\r\n            logger.log(\"INFO\", \"MIDROW: \" + JSON.stringify(styles));\r\n            this.writeScreen.setPen(styles);\r\n        },\r\n\r\n        outputDataUpdate: function() {\r\n            var t = logger.time;\r\n            if (t === null) {\r\n                return;\r\n            }\r\n            if (this.outputFilter) {\r\n                if (this.outputFilter.updateData) {\r\n                    this.outputFilter.updateData(t, this.displayedMemory);\r\n                }\r\n                if (this.cueStartTime === null && !this.displayedMemory.isEmpty()) { // Start of a new cue\r\n                    this.cueStartTime = t;\r\n                } else {\r\n                    if (!this.displayedMemory.equals(this.lastOutputScreen)) { \r\n                        if (this.outputFilter.newCue) {\r\n                            this.outputFilter.newCue(this.cueStartTime, t, this.lastOutputScreen);\r\n                        }\r\n                        this.cueStartTime = this.displayedMemory.isEmpty() ? null : t;\r\n                    }\r\n                }\r\n                this.lastOutputScreen.copy(this.displayedMemory);\r\n            }\r\n        },\r\n\r\n        cueSplitAtTime : function(t) {\r\n            if (this.outputFilter) {\r\n                if (!this.displayedMemory.isEmpty()) {\r\n                    if (this.outputFilter.newCue) {\r\n                        this.outputFilter.newCue(this.cueStartTime, t, this.displayedMemory);\r\n                    }\r\n                    this.cueStartTime = t;\r\n                }\r\n            }\r\n        }\r\n    };\r\n\r\n    /**\r\n     * Parse CEA-608 data and send decoded data to out1 and out2.\r\n     * @constructor\r\n     * @param {Number} field  CEA-608 field (1 or 2)\r\n     * @param {CueHandler} out1 Output from channel1 newCue(startTime, endTime, captionScreen)\r\n     * @param {CueHandler} out2 Output from channel2 newCue(startTime, endTime, captionScreen)\r\n     */\r\n    var Cea608Parser = function(field, out1, out2) {\r\n        this.field = field || 1;\r\n        this.outputs = [out1, out2];\r\n        this.channels = [new Cea608Channel(1, out1), new Cea608Channel(2, out2)];\r\n        this.currChNr = -1; // Will be 1 or 2\r\n        this.lastCmdA = null; // First byte of last command\r\n        this.lastCmdB = null; // Second byte of last command\r\n        this.bufferedData = [];\r\n        this.startTime = null;\r\n        this.lastTime = null;\r\n        this.dataCounters = {'padding' : 0, 'char' : 0, 'cmd' : 0, 'other' : 0};\r\n    };\r\n\r\n    Cea608Parser.prototype = {\r\n        \r\n        getHandler : function(index) {\r\n            return this.channels[index].getHandler();\r\n        },\r\n        \r\n        setHandler : function(index, newHandler) {\r\n            this.channels[index].setHandler(newHandler);\r\n        },\r\n\r\n        /**\r\n         * Add data for time t in forms of list of bytes (unsigned ints). The bytes are treated as pairs.\r\n         */\r\n        addData : function(t, byteList) {\r\n            var cmdFound, a, b, \r\n            charsFound = false;\r\n            \r\n            this.lastTime = t;\r\n            logger.setTime(t);\r\n\r\n            for (var i = 0 ; i < byteList.length ; i+=2) {\r\n                a = byteList[i] & 0x7f;\r\n                b = byteList[i+1] & 0x7f;\r\n\r\n                if (a >= 0x10 && a <= 0x1f && a === this.lastCmdA && b === this.lastCmdB) {\r\n                    this.lastCmdA = null;\r\n                    this.lastCmdB = null;\r\n                    logger.log(\"DEBUG\", \"Repeated command (\" + numArrayToHexArray([a, b]) + \") is dropped\");\r\n                    continue; // Repeated commands are dropped (once)\r\n                }\r\n\r\n                if (a === 0 && b === 0) {\r\n                    this.dataCounters.padding += 2;\r\n                    continue;\r\n                } else {\r\n                    logger.log(\"DATA\", \"[\" + numArrayToHexArray([byteList[i], byteList[i+1]]) +\"] -> (\" + numArrayToHexArray([a, b]) + \")\");\r\n                }\r\n                cmdFound = this.parseCmd(a, b);\r\n                if (!cmdFound) {\r\n                    cmdFound = this.parseMidrow(a, b);\r\n                }\r\n                if (!cmdFound) {\r\n                    cmdFound = this.parsePAC(a, b);\r\n                }\r\n                if (!cmdFound) {\r\n                    cmdFound = this.parseBackgroundAttributes(a, b);\r\n                }\r\n                if (!cmdFound) {\r\n                    charsFound = this.parseChars(a, b);\r\n                    if (charsFound) {\r\n                        if (this.currChNr && this.currChNr >=0) {\r\n                            var channel = this.channels[this.currChNr-1];\r\n                            channel.insertChars(charsFound);\r\n                        } else {\r\n                            logger.log(\"WARNING\", \"No channel found yet. TEXT-MODE?\");\r\n                        }\r\n                    }\r\n                }\r\n                if (cmdFound) {\r\n                    this.dataCounters.cmd += 2;\r\n                } else if (charsFound) {\r\n                    this.dataCounters.char += 2;\r\n                } else {\r\n                    this.dataCounters.other += 2;\r\n                    logger.log(\"WARNING\", \"Couldn't parse cleaned data \" + numArrayToHexArray([a, b]) +\r\n                                \" orig: \" + numArrayToHexArray([byteList[i], byteList[i+1]]));\r\n                }\r\n            }\r\n        },\r\n\r\n        /**\r\n         * Parse Command.\r\n         * @returns {Boolean} Tells if a command was found\r\n         */\r\n        parseCmd: function(a, b) {\r\n            var chNr = null;\r\n\r\n            var cond1 = (a === 0x14 || a === 0x15 || a === 0x1C || a === 0x1D) && (0x20 <= b && b <= 0x2F);\r\n            var cond2 = (a === 0x17 || a === 0x1F) && (0x21 <= b && b <= 0x23);\r\n            if (!(cond1 || cond2)) {\r\n                return false;\r\n            }\r\n                 \r\n            if (a === 0x14 || a === 0x15 || a === 0x17) {\r\n                chNr = 1;\r\n            } else {\r\n                chNr = 2; // (a === 0x1C || a === 0x1D || a=== 0x1f)\r\n            }\r\n\r\n            var channel = this.channels[chNr - 1];\r\n\r\n            if (a === 0x14 || a === 0x15 || a === 0x1C || a === 0x1D) {\r\n                if (b === 0x20) {\r\n                    channel.cc_RCL();\r\n                } else if (b === 0x21) {\r\n                    channel.cc_BS();\r\n                } else if (b === 0x22) {\r\n                    channel.cc_AOF();\r\n                } else if (b === 0x23) {\r\n                    channel.cc_AON();\r\n                } else if (b === 0x24) {\r\n                    channel.cc_DER();\r\n                } else if (b === 0x25) {\r\n                    channel.cc_RU(2);\r\n                } else if (b === 0x26) {\r\n                    channel.cc_RU(3);\r\n                } else if (b === 0x27) {\r\n                    channel.cc_RU(4);\r\n                } else if (b === 0x28) {\r\n                    channel.cc_FON();\r\n                } else if (b === 0x29) {\r\n                    channel.cc_RDC();\r\n                } else if (b === 0x2A) {\r\n                    channel.cc_TR();\r\n                } else if (b === 0x2B) {\r\n                    channel.cc_RTD();\r\n                } else if (b === 0x2C) {\r\n                    channel.cc_EDM();\r\n                } else if (b === 0x2D) {\r\n                    channel.cc_CR();\r\n                } else if (b === 0x2E) {\r\n                    channel.cc_ENM();\r\n                } else if (b === 0x2F) {\r\n                    channel.cc_EOC();\r\n                }\r\n            } else { //a == 0x17 || a == 0x1F\r\n                channel.cc_TO(b - 0x20);\r\n            }\r\n            this.lastCmdA = a;\r\n            this.lastCmdB = b;\r\n            this.currChNr = chNr;\r\n            return true;\r\n        },\r\n\r\n        /**\r\n         * Parse midrow styling command\r\n         * @returns {Boolean}\r\n         */\r\n        parseMidrow : function(a, b) {\r\n            var chNr = null;\r\n                \r\n            if ( ((a === 0x11) || (a === 0x19)) && 0x20 <= b && b <= 0x2f) {\r\n                if (a === 0x11) {\r\n                    chNr = 1;\r\n                } else  {\r\n                    chNr = 2;\r\n                }\r\n                if (chNr !== this.currChNr) {\r\n                    logger.log(\"ERROR\", \"Mismatch channel in midrow parsing\");\r\n                    return false;\r\n                }\r\n                var channel = this.channels[chNr-1];\r\n                // cea608 spec says midrow codes should inject a space\r\n                channel.insertChars([0x20]);\r\n                channel.cc_MIDROW(b);\r\n                logger.log(\"DEBUG\", \"MIDROW (\" + numArrayToHexArray([a, b]) + \")\");\r\n                this.lastCmdA = a;\r\n                this.lastCmdB = b;\r\n                return true;\r\n            }\r\n            return false;\r\n        },\r\n        /**\r\n         * Parse Preable Access Codes (Table 53).\r\n         * @returns {Boolean} Tells if PAC found\r\n         */\r\n        parsePAC : function(a, b) {\r\n\r\n           var chNr = null;\r\n           var row = null;\r\n            \r\n            var case1 = ((0x11 <= a  && a <= 0x17) || (0x19 <= a && a <= 0x1F)) && (0x40 <= b && b <= 0x7F);\r\n            var case2 = (a === 0x10 || a === 0x18) && (0x40 <= b && b <= 0x5F);\r\n            if (! (case1 || case2)) {\r\n                return false;\r\n            }\r\n\r\n            chNr = (a <= 0x17) ? 1 : 2;\r\n\r\n            if (0x40 <= b && b <= 0x5F) {\r\n                row = (chNr === 1) ? rowsLowCh1[a] : rowsLowCh2[a];\r\n            } else { // 0x60 <= b <= 0x7F\r\n                row = (chNr === 1) ? rowsHighCh1[a] : rowsHighCh2[a];\r\n            }\r\n            var pacData = this.interpretPAC(row, b);\r\n            var channel = this.channels[chNr-1];\r\n            channel.setPAC(pacData);\r\n            this.lastCmdA = a;\r\n            this.lastCmdB = b;\r\n            this.currChNr = chNr;\r\n            return true;\r\n        },\r\n\r\n        /**\r\n         * Interpret the second byte of the pac, and return the information.\r\n         * @returns {Object} pacData with style parameters.\r\n         */\r\n        interpretPAC : function (row, byte) {\r\n            var pacIndex = byte;\r\n            var pacData = {color : null, italics : false, indent : null, underline : false, row : row};\r\n            \r\n            if (byte > 0x5F) {\r\n                pacIndex = byte - 0x60;\r\n            } else {\r\n                pacIndex = byte - 0x40;\r\n            }\r\n            pacData.underline = (pacIndex & 1) === 1;\r\n            if (pacIndex <= 0xd) {\r\n                pacData.color = ['white', 'green', 'blue', 'cyan', 'red', 'yellow', 'magenta', 'white'][Math.floor(pacIndex/2)];\r\n            } else if (pacIndex <= 0xf) {\r\n                pacData.italics = true;\r\n                pacData.color = 'white';\r\n            } else {\r\n                pacData.indent = (Math.floor((pacIndex-0x10)/2))*4;\r\n            }\r\n            return pacData; // Note that row has zero offset. The spec uses 1.\r\n        },\r\n\r\n        /**\r\n         * Parse characters.\r\n         * @returns An array with 1 to 2 codes corresponding to chars, if found. null otherwise.\r\n         */\r\n        parseChars : function(a, b) {\r\n\r\n           var  channelNr = null,\r\n                charCodes = null,\r\n                charCode1 = null,\r\n                charCode2 = null;\r\n\r\n            if (a >= 0x19) {\r\n                channelNr = 2;\r\n                charCode1 = a - 8;\r\n            } else {\r\n                channelNr = 1;\r\n                charCode1 = a;\r\n            }\r\n            if (0x11 <= charCode1 && charCode1 <= 0x13) {\r\n                // Special character\r\n                var oneCode = b;\r\n                if (charCode1 === 0x11) {\r\n                    oneCode = b + 0x50;\r\n                } else if (charCode1 === 0x12) {\r\n                    oneCode = b + 0x70;\r\n                } else {\r\n                    oneCode = b + 0x90;\r\n                }\r\n                logger.log(\"INFO\", \"Special char '\" + getCharForByte(oneCode) + \"' in channel \" + channelNr);\r\n                charCodes = [oneCode];\r\n                this.lastCmdA = a;\r\n                this.lastCmdB = b;\r\n            } else if (0x20 <= a && a <= 0x7f) {\r\n                charCodes = (b === 0) ? [a] : [a, b];\r\n                this.lastCmdA = null;\r\n                this.lastCmdB = null;\r\n            }\r\n            if (charCodes) {\r\n                var hexCodes = numArrayToHexArray(charCodes);\r\n                logger.log(\"DEBUG\", \"Char codes =  \" + hexCodes.join(\",\"));\r\n            }\r\n            return charCodes;\r\n        },\r\n        \r\n        /**\r\n        * Parse extended background attributes as well as new foreground color black.\r\n        * @returns{Boolean} Tells if background attributes are found\r\n        */\r\n        parseBackgroundAttributes : function(a, b) {\r\n           var  bkgData,\r\n                index,\r\n                chNr,\r\n                channel;\r\n\r\n            var case1 = (a === 0x10 || a === 0x18) && (0x20 <= b && b <= 0x2f);\r\n            var case2 = (a === 0x17 || a === 0x1f) && (0x2d <=b && b <= 0x2f);\r\n            if (!(case1 || case2)) {\r\n                return false;\r\n            }\r\n            bkgData = {};\r\n            if (a  === 0x10 || a === 0x18) {\r\n                index = Math.floor((b-0x20)/2);\r\n                bkgData.background = backgroundColors[index];\r\n                if (b % 2 === 1) {\r\n                    bkgData.background = bkgData.background + \"_semi\";\r\n                }\r\n            } else if (b === 0x2d) {\r\n                bkgData.background = \"transparent\";\r\n            } else {\r\n                bkgData.foreground = \"black\";\r\n                if (b === 0x2f) {\r\n                    bkgData.underline = true;\r\n                }\r\n            }\r\n            chNr = (a < 0x18) ? 1 : 2;\r\n            channel = this.channels[chNr-1];\r\n            channel.setBkgData(bkgData);\r\n            this.lastCmdA = a;\r\n            this.lastCmdB = b;\r\n            return true;\r\n        },\r\n\r\n        /**\r\n         * Reset state of parser and its channels.\r\n         */\r\n        reset : function() {\r\n            for (var i=0 ; i < this.channels.length ; i++) {\r\n                if (this.channels[i]) {\r\n                    this.channels[i].reset();\r\n                }\r\n            }\r\n            this.lastCmdA = null;\r\n            this.lastCmdB = null;\r\n        },\r\n\r\n        /**\r\n         * Trigger the generation of a cue, and the start of a new one if displayScreens are not empty.\r\n         */\r\n        cueSplitAtTime : function(t) {\r\n            for (var i=0 ; i < this.channels.length ; i++) {\r\n                if (this.channels[i]) {\r\n                    this.channels[i].cueSplitAtTime(t);\r\n                }\r\n            }\r\n        },\r\n    };\r\n\r\n    /**\r\n     * Find ranges corresponding to SEA CEA-608 NALUS in sizeprepended NALU array.\r\n     * @param {raw} dataView of binary data\r\n     * @param {startPos} start position in raw\r\n     * @param {size} total size of data in raw to consider\r\n     * @returns \r\n     */\r\n    var findCea608Nalus = function(raw, startPos, size) {\r\n        var nalSize = 0,\r\n            cursor = startPos,\r\n            nalType = 0,\r\n            cea608NaluRanges = [],\r\n            // Check SEI data according to ANSI-SCTE 128\r\n            isCEA608SEI = function (payloadType, payloadSize, raw, pos) {\r\n                if (payloadType !== 4 || payloadSize < 8) {\r\n                    return null;\r\n                }\r\n                var countryCode = raw.getUint8(pos);\r\n                var providerCode = raw.getUint16(pos + 1);\r\n                var userIdentifier = raw.getUint32(pos + 3);\r\n                var userDataTypeCode = raw.getUint8(pos + 7);\r\n                return countryCode == 0xB5 && providerCode == 0x31 && userIdentifier == 0x47413934 && userDataTypeCode == 0x3;\r\n            };\r\n        while (cursor < startPos + size) {\r\n            nalSize = raw.getUint32(cursor);\r\n            nalType = raw.getUint8(cursor + 4) & 0x1F;\r\n            //console.log(time + \"  NAL \" + nalType);\r\n            if (nalType === 6) {\r\n                // SEI NAL Unit. The NAL header is the first byte\r\n                //console.log(\"SEI NALU of size \" + nalSize + \" at time \" + time);\r\n                var pos = cursor + 5;\r\n                var payloadType = -1;\r\n                while (pos < cursor + 4 + nalSize - 1) { // The last byte should be rbsp_trailing_bits\r\n                    payloadType = 0;\r\n                    var b = 0xFF;\r\n                    while (b === 0xFF) {\r\n                        b = raw.getUint8(pos);\r\n                        payloadType += b;\r\n                        pos++;\r\n                    }\r\n                    var payloadSize = 0;\r\n                    b = 0xFF;\r\n                    while (b === 0xFF) {\r\n                        b = raw.getUint8(pos);\r\n                        payloadSize += b;\r\n                        pos++;\r\n                    }\r\n                    if (isCEA608SEI(payloadType, payloadSize, raw, pos)) {\r\n                        //console.log(\"CEA608 SEI \" + time + \" \" + payloadSize);\r\n                        cea608NaluRanges.push([pos, payloadSize]);\r\n                    }\r\n                    pos += payloadSize;\r\n                }\r\n            }\r\n            cursor += nalSize + 4;\r\n        }\r\n        return cea608NaluRanges;\r\n    };\r\n    \r\n    var extractCea608DataFromRange = function(raw, cea608Range) {\r\n        var pos = cea608Range[0];\r\n        var fieldData = [[], []];\r\n\r\n        pos += 8; // Skip the identifier up to userDataTypeCode\r\n        var ccCount = raw.getUint8(pos) & 0x1f;\r\n        pos += 2; // Advance 1 and skip reserved byte\r\n          \r\n        for (var i = 0; i < ccCount; i++) {\r\n            var byte = raw.getUint8(pos);\r\n            var ccValid = byte & 0x4;\r\n            var ccType = byte & 0x3;\r\n            pos++;\r\n            var ccData1 = raw.getUint8(pos); // Keep parity bit\r\n            pos++;\r\n            var ccData2 = raw.getUint8(pos); // Keep parity bit\r\n            pos++;\r\n            if (ccValid && ((ccData1 & 0x7f) + (ccData2 & 0x7f) !== 0)) { //Check validity and non-empty data\r\n                if (ccType === 0) {\r\n                    fieldData[0].push(ccData1);\r\n                    fieldData[0].push(ccData2);\r\n                } else if (ccType === 1) {\r\n                    fieldData[1].push(ccData1);\r\n                    fieldData[1].push(ccData2);\r\n                }\r\n            }\r\n        }\r\n        return fieldData;\r\n    };\r\n\r\n    exports.logger = logger;\r\n    exports.PenState = PenState;\r\n    exports.CaptionScreen = CaptionScreen;  \r\n    exports.Cea608Parser = Cea608Parser;\r\n    exports.findCea608Nalus = findCea608Nalus;\r\n    exports.extractCea608DataFromRange = extractCea608DataFromRange;\r\n\r\n}(typeof exports === 'undefined' ? this.cea608parser = {} : exports));\r\n"]}